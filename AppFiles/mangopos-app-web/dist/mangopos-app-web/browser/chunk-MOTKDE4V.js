import{a as ge}from"./chunk-4LX67P6M.js";import{a as he}from"./chunk-7MVBSPFH.js";import{a as me}from"./chunk-6XGWOI35.js";import{a as O,b as E,c as ue,h as T}from"./chunk-Z6YHTX75.js";import{a as ae,b as ce}from"./chunk-26KDQVR5.js";import{a as pe}from"./chunk-DGQM6DPS.js";import{b as se,f as le,j as de,x as M}from"./chunk-AVLO2MYP.js";import{a as I,b as D}from"./chunk-JI7GBIO6.js";import{I as oe,K as re}from"./chunk-M7DMR53X.js";import{k as ee,l as te,s as ie,u as ne,v as P}from"./chunk-ZD4QWOHN.js";import{$b as U,Ac as X,Fb as l,Gb as o,Hb as r,Ib as w,Pb as j,Sa as $,Ua as K,Ub as p,W as L,Wa as c,Wb as f,_ as N,_b as H,a as F,ac as q,db as m,ea as S,ec as Y,f as R,fa as b,gc as x,ic as a,jb as y,jc as h,kc as v,n as W,na as V,nc as Q,oc as Z,pb as C,pc as G,vc as k,xc as J,zc as B}from"./chunk-WSMHJDAT.js";import{a as z,b as A}from"./chunk-C6Q5SG76.js";var _e=(()=>{class s{zone;port=null;reader=null;keepReading=!1;pollInterval=null;weightSubject=new R(0);weight$=this.weightSubject.asObservable();statusSubject=new R({connected:!1,isStable:!1});status$=this.statusSubject.asObservable();lastWeights=[];STABILITY_THRESHOLD=.005;STABILITY_COUNT=5;constructor(e){this.zone=e,this.checkAuthorizedPorts()}async checkAuthorizedPorts(){if("serial"in navigator){let n=await navigator.serial.getPorts();n.length>0&&console.log("Puertos autorizados encontrados:",n.length)}}async connect(){if(!("serial"in navigator))return this.statusSubject.next({connected:!1,isStable:!1,error:"Web Serial no soportado"}),!1;try{let e=navigator.serial;return this.port=await e.requestPort(),await this.port.open({baudRate:9600,dataBits:8,stopBits:1,parity:"none"}),this.statusSubject.next({connected:!0,isStable:!1}),this.startReading(),!0}catch(e){return console.error("Error al conectar balanza:",e),this.statusSubject.next({connected:!1,isStable:!1,error:String(e)}),!1}}async disconnect(){this.keepReading=!1,this.pollInterval&&(clearInterval(this.pollInterval),this.pollInterval=null),this.reader&&await this.reader.cancel(),this.port&&await this.port.close(),this.port=null,this.statusSubject.next({connected:!1,isStable:!1})}async startReading(){for(this.keepReading=!0,this.pollInterval=setInterval(()=>{this.requestWeight()},500);this.port?.readable&&this.keepReading;){this.reader=this.port.readable.getReader();try{let e="";for(;;){let{value:n,done:t}=await this.reader.read();if(t)break;if(n)for(let i=0;i<n.length;i++){let u=n[i];if(u===30){let d=parseFloat(e);isNaN(d)||this.zone.run(()=>this.updateWeight(d/1e3)),e=""}else u>=48&&u<=57?e+=String.fromCharCode(u):u===46?e+=".":e=""}}}catch(e){console.error("Error de lectura:",e)}finally{this.reader.releaseLock()}}}updateWeight(e){if(this.weightSubject.next(e),this.lastWeights.push(e),this.lastWeights.length>this.STABILITY_COUNT&&this.lastWeights.shift(),this.lastWeights.length===this.STABILITY_COUNT){let n=Math.max(...this.lastWeights),t=Math.min(...this.lastWeights),i=n-t<=this.STABILITY_THRESHOLD,u=this.statusSubject.value;u.isStable!==i&&this.statusSubject.next(A(z({},u),{isStable:i}))}}async requestWeight(){if(this.port?.writable){let e=this.port.writable.getWriter(),n=new Uint8Array([5]);await e.write(n),e.releaseLock()}}static \u0275fac=function(n){return new(n||s)(N(V))};static \u0275prov=L({token:s,factory:s.\u0275fac,providedIn:"root"})}return s})();var Se=(()=>{class s{dialogRef;data;scaleService;weightStr="0";productName="";scaleStatus={connected:!1,isStable:!1};subscription=new F;constructor(e,n,t){this.dialogRef=e,this.data=n,this.scaleService=t,this.productName=n.product.name}ngOnInit(){this.subscription.add(this.scaleService.weight$.subscribe(e=>{this.scaleStatus.connected&&(this.weightStr=e.toFixed(3))})),this.subscription.add(this.scaleService.status$.subscribe(e=>{this.scaleStatus=e}))}ngOnDestroy(){this.subscription.unsubscribe()}async toggleScaleConnection(){this.scaleStatus.connected?await this.scaleService.disconnect():await this.scaleService.connect()}handleKeyboardEvent(e){e.key>="0"&&e.key<="9"?this.addDigit(e.key):e.key==="."||e.key===","?this.addDigit("."):e.key==="Backspace"?this.weightStr.length>1?this.weightStr=this.weightStr.slice(0,-1):this.weightStr="0":e.key==="Enter"?this.onConfirm():e.key==="Escape"?this.onCancel():e.key.toLowerCase()==="c"&&this.clear()}onCancel(){this.dialogRef.close()}onConfirm(){let e=parseFloat(this.weightStr);e>0&&this.dialogRef.close(e)}addDigit(e){e==="."&&this.weightStr.includes(".")||(this.weightStr==="0"&&e!=="."?this.weightStr=e:this.weightStr+=e)}clear(){this.weightStr="0"}get weight(){return parseFloat(this.weightStr)}static \u0275fac=function(n){return new(n||s)(m(O),m(E),m(_e))};static \u0275cmp=y({type:s,selectors:[["app-scale-weight-dialog"]],hostBindings:function(n,t){n&1&&p("keydown",function(u){return t.handleKeyboardEvent(u)},K)},decls:55,vars:24,consts:[[1,"scale-dialog"],[1,"dialog-header"],[1,"header-main"],["color","primary"],[1,"scale-status"],[1,"status-dot"],[1,"product-info"],[1,"value"],[1,"display-container"],[1,"weight-display-card"],["matTooltip","Peso Estable",1,"stability-light"],[1,"weight-value"],["mat-stroked-button","","color","primary",1,"btn-connect",3,"click"],[1,"manual-input-section"],[1,"subtitle"],[1,"numpad"],["type","button",3,"click","disabled"],["type","button",1,"btn-clear",3,"click","disabled"],[1,"actions"],["mat-button","",3,"click"],["mat-raised-button","","color","primary",1,"btn-confirm",3,"click","disabled"]],template:function(n,t){n&1&&(o(0,"div",0)(1,"header",1)(2,"div",2)(3,"mat-icon",3),a(4,"scale"),r(),o(5,"h2"),a(6,"Pesa el Producto"),r()(),o(7,"div",4),w(8,"span",5),a(9),r()(),o(10,"div",6)(11,"span",7),a(12),r()(),o(13,"div",8)(14,"div",9),w(15,"div",10),o(16,"div",11),a(17),r()(),o(18,"button",12),p("click",function(){return t.toggleScaleConnection()}),o(19,"mat-icon"),a(20),r(),a(21),r()(),o(22,"div",13)(23,"p",14),a(24,"Ingreso Manual"),r(),o(25,"div",15)(26,"button",16),p("click",function(){return t.addDigit("1")}),a(27,"1"),r(),o(28,"button",16),p("click",function(){return t.addDigit("2")}),a(29,"2"),r(),o(30,"button",16),p("click",function(){return t.addDigit("3")}),a(31,"3"),r(),o(32,"button",16),p("click",function(){return t.addDigit("4")}),a(33,"4"),r(),o(34,"button",16),p("click",function(){return t.addDigit("5")}),a(35,"5"),r(),o(36,"button",16),p("click",function(){return t.addDigit("6")}),a(37,"6"),r(),o(38,"button",16),p("click",function(){return t.addDigit("7")}),a(39,"7"),r(),o(40,"button",16),p("click",function(){return t.addDigit("8")}),a(41,"8"),r(),o(42,"button",16),p("click",function(){return t.addDigit("9")}),a(43,"9"),r(),o(44,"button",16),p("click",function(){return t.addDigit(".")}),a(45,"."),r(),o(46,"button",16),p("click",function(){return t.addDigit("0")}),a(47,"0"),r(),o(48,"button",17),p("click",function(){return t.clear()}),a(49,"C"),r()()(),o(50,"footer",18)(51,"button",19),p("click",function(){return t.onCancel()}),a(52,"CANCELAR"),r(),o(53,"button",20),p("click",function(){return t.onConfirm()}),a(54," CONFIRMAR PESO "),r()()()),n&2&&(c(7),x("online",t.scaleStatus.connected),c(2),v(" ",t.scaleStatus.connected?"Balanza Conectada":"Balanza Desconectada"," "),c(3),h(t.productName),c(2),x("stable",t.scaleStatus.isStable),c(),x("active",t.scaleStatus.isStable),c(2),h(t.weightStr),c(3),h(t.scaleStatus.connected?"link_off":"usb"),c(),v(" ",t.scaleStatus.connected?"Desconectar":"Conectar Balanza"," "),c(5),l("disabled",t.scaleStatus.connected),c(2),l("disabled",t.scaleStatus.connected),c(2),l("disabled",t.scaleStatus.connected),c(2),l("disabled",t.scaleStatus.connected),c(2),l("disabled",t.scaleStatus.connected),c(2),l("disabled",t.scaleStatus.connected),c(2),l("disabled",t.scaleStatus.connected),c(2),l("disabled",t.scaleStatus.connected),c(2),l("disabled",t.scaleStatus.connected),c(2),l("disabled",t.scaleStatus.connected),c(2),l("disabled",t.scaleStatus.connected),c(2),l("disabled",t.scaleStatus.connected),c(5),l("disabled",t.weight<=0))},dependencies:[P,M,T,D,I,re,oe],styles:[".scale-dialog[_ngcontent-%COMP%]{padding:24px;display:flex;flex-direction:column;gap:20px;background:#fff}.dialog-header[_ngcontent-%COMP%]{display:flex;align-items:center;gap:12px}.dialog-header[_ngcontent-%COMP%]   h2[_ngcontent-%COMP%]{margin:0;font-size:1.5rem}.product-info[_ngcontent-%COMP%]{font-size:1.1rem}.product-info[_ngcontent-%COMP%]   .value[_ngcontent-%COMP%]{color:#666;margin-right:8px;margin-bottom:24px;padding:16px;background:#f8fafc;border-radius:12px}.product-info[_ngcontent-%COMP%]   .value[_ngcontent-%COMP%]   .label[_ngcontent-%COMP%]{font-size:.875rem;color:#64748b;font-weight:600;margin-right:8px}.product-info[_ngcontent-%COMP%]   .value[_ngcontent-%COMP%]   .value[_ngcontent-%COMP%]{color:#64748b;margin-right:8px;font-size:1.125rem;font-weight:800;color:#1e293b}.display-container[_ngcontent-%COMP%]{display:flex;flex-direction:column;align-items:center;gap:16px;margin-bottom:20px}.weight-display-card[_ngcontent-%COMP%]{position:relative;width:90%;background:#0f172a;border-radius:16px;padding:40px 20px;display:flex;align-items:baseline;justify-content:center;gap:12px;box-shadow:0 10px 25px -5px #0000001a;transition:all .3s;border:4px solid transparent}.weight-display-card.stable[_ngcontent-%COMP%]{border-color:#22c55e;box-shadow:0 0 20px #22c55e33}.weight-display-card[_ngcontent-%COMP%]   .stability-light[_ngcontent-%COMP%]{position:absolute;top:20px;left:20px;width:12px;height:12px;background:#334155;border-radius:50%;transition:all .2s}.weight-display-card[_ngcontent-%COMP%]   .stability-light.active[_ngcontent-%COMP%]{background:#22c55e;box-shadow:0 0 10px #22c55e}.weight-display-card[_ngcontent-%COMP%]   .weight-value[_ngcontent-%COMP%]{font-family:Digital-7,Courier New,Courier,monospace;font-size:4rem;font-weight:800;color:#22c55e;letter-spacing:2px;line-height:1}.weight-display-card[_ngcontent-%COMP%]   .unit[_ngcontent-%COMP%]{font-size:1rem;font-weight:700;color:#acb5bd}.btn-connect[_ngcontent-%COMP%]{width:100%;height:48px;border-radius:12px;font-weight:700}.manual-input-section[_ngcontent-%COMP%]   .subtitle[_ngcontent-%COMP%]{font-size:.75rem;font-weight:800;color:#64748b;text-transform:uppercase;margin-bottom:10px;letter-spacing:.05em}.numpad[_ngcontent-%COMP%]{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}.numpad[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]{height:54px;border:none;background:#f1f5f9;border-radius:10px;font-size:1.25rem;font-weight:700;color:#334155;cursor:pointer;transition:all .1s}.numpad[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]:active{background:#e2e8f0;transform:scale(.95)}.numpad[_ngcontent-%COMP%]   button.btn-clear[_ngcontent-%COMP%]{color:#ef4444;background:#fef2f2}.actions[_ngcontent-%COMP%]{margin-top:24px;display:flex;gap:16px}.actions[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]{flex:1;height:56px;border-radius:12px;font-size:1rem;font-weight:800}"]})}return s})();var we=["searchInput"];function ye(s,g){if(s&1&&w(0,"img",20),s&2){let e=f().$implicit;l("src","data:image/png;base64,"+e.image,$)}}function ke(s,g){s&1&&(o(0,"div",21)(1,"mat-icon"),a(2,"image"),r()())}function Pe(s,g){if(s&1){let e=j();o(0,"div",11),p("click",function(){let t=S(e).$implicit,i=f(2);return b(i.selectProduct(t))})("mouseenter",function(){let t=S(e).index,i=f(2);return b(i.selectedIndex=t)}),C(1,ye,1,1,"img",12)(2,ke,3,0,"div",13),o(3,"div",14)(4,"div",15),a(5),r(),o(6,"div",16)(7,"span"),a(8),r(),o(9,"div",17)(10,"span",18),a(11),k(12,"currency"),r(),o(13,"span",19),a(14),k(15,"currency"),r()(),o(16,"span"),a(17),k(18,"number"),r()()()()}if(s&2){let e=g.$implicit,n=g.index,t=f(2);x("selected",n===t.selectedIndex),c(),l("ngIf",e.image),c(),l("ngIf",!e.image),c(3),h(e.name),c(3),v("Ref: ",e.reference),c(3),h(B(12,9,e.pricesell*(1+(e.tax_rate-0||0))*t.exchangeRate,"VES","Bs. ",t.settingsService.getDecimalFormat("price"))),c(3),h(B(15,14,e.pricesell*(1+(e.tax_rate-0||0)),"USD","$ ",t.settingsService.getDecimalFormat("price"))),c(3),v("Stock: ",J(18,19,e.stock,t.settingsService.getDecimalFormat("quantity")))}}function Me(s,g){if(s&1&&(o(0,"div",9),C(1,Pe,19,22,"div",10),r()),s&2){let e=f();c(),l("ngForOf",e.filteredProducts)}}function Ie(s,g){s&1&&(o(0,"div",23)(1,"mat-icon"),a(2,"search_off"),r(),o(3,"span"),a(4,"No se encontraron productos"),r()())}function De(s,g){s&1&&(o(0,"div",23)(1,"mat-icon"),a(2,"manage_search"),r(),o(3,"span"),a(4,"Escriba para buscar..."),r()())}function Oe(s,g){if(s&1&&C(0,Ie,5,0,"div",22)(1,De,5,0,"div",22),s&2){let e=f();l("ngIf",e.searchText),c(),l("ngIf",!e.searchText)}}var ht=(()=>{class s{dialogRef;salesService;settingsService;dialog;snackBar;productKitService;compoundProductsService;data;products=[];filteredProducts=[];searchText="";selectedIndex=0;exchangeRate=1;searchInput;constructor(e,n,t,i,u,d,_,be){this.dialogRef=e,this.salesService=n,this.settingsService=t,this.dialog=i,this.snackBar=u,this.productKitService=d,this.compoundProductsService=_,this.data=be}ngOnInit(){this.salesService.getCatalog().subscribe(e=>{this.products=e.products,this.filteredProducts=[]}),this.salesService.exchangeRate$.subscribe(e=>{this.exchangeRate=e})}ngAfterViewInit(){setTimeout(()=>this.searchInput.nativeElement.focus())}onSearch(e){if(!e){this.filteredProducts=[],this.selectedIndex=-1;return}let n=e.toLowerCase(),t=this.products.filter(i=>i.name.toLowerCase().includes(n)||i.code.toLowerCase().includes(n)||i.reference.toLowerCase().includes(n));this.data?.purchasableOnly&&(t=t.filter(i=>i.iscom)),this.filteredProducts=t.slice(0,50),this.selectedIndex=this.filteredProducts.length>0?0:-1}onKeyDown(e){e.key==="ArrowDown"?(e.preventDefault(),this.selectedIndex<this.filteredProducts.length-1&&(this.selectedIndex++,this.scrollToSelected())):e.key==="ArrowUp"?(e.preventDefault(),this.selectedIndex>0&&(this.selectedIndex--,this.scrollToSelected())):e.key==="Enter"?(e.preventDefault(),this.selectedIndex>=0&&this.filteredProducts[this.selectedIndex]&&this.selectProduct(this.filteredProducts[this.selectedIndex])):e.key==="Escape"&&this.dialogRef.close()}scrollToSelected(){let e=document.querySelector(".product-item.selected");e&&e.scrollIntoView({block:"nearest",behavior:"smooth"})}async selectProduct(e){let n=this.data?.allowZeroStock||!1,t=!!(e.servicio&&e.servicio!=="0"&&e.servicio!==!1),i=e.typeproduct==="CO",u=e.typeproduct==="KI";if(!n&&!t&&!i&&!u&&e.stock<=0){this.snackBar.open(`No hay stock disponible para ${e.name}`,"Cerrar",{duration:3e3});return}if(!n&&i)try{let d=await W(this.compoundProductsService.validateStock(e.id,1));if(!d.hasStock){this.snackBar.open(`Faltan insumos para "${e.name}": ${d.message}`,"Cerrar",{duration:5e3});return}}catch(d){console.error("Error validating compound stock:",d)}if(!n&&u)try{if(!(await W(this.productKitService.validateStock(e.id,1))).hasStock){this.snackBar.open(`Stock insuficiente de componentes para el combo "${e.name}".`,"Cerrar",{duration:5e3});return}}catch(d){console.error("Error validating kit stock:",d)}e.isscale?this.dialog.open(Se,{width:"400px",data:{product:e}}).afterClosed().subscribe(_=>{if(_){if(!t&&!i&&!u&&_>e.stock){this.snackBar.open(`Cantidad pedida (${_}) excede el stock (${e.stock})`,"Cerrar",{duration:3e3});return}this.dialogRef.close({product:e,units:_})}}):this.dialogRef.close({product:e,units:1})}static \u0275fac=function(n){return new(n||s)(m(O),m(me),m(pe),m(ue),m(ae),m(ge),m(he),m(E))};static \u0275cmp=y({type:s,selectors:[["app-product-search-dialog"]],viewQuery:function(n,t){if(n&1&&H(we,5),n&2){let i;U(i=q())&&(t.searchInput=i.first)}},decls:11,vars:3,consts:[["searchInput",""],["noResults",""],[1,"search-container"],[1,"search-header"],[1,"search-input-wrapper"],[1,"search-icon"],["type","text","placeholder","Buscar producto (ESC para salir)...","autocomplete","off",3,"ngModelChange","keydown","ngModel"],[1,"search-results"],["class","product-list",4,"ngIf","ngIfElse"],[1,"product-list"],["class","product-item",3,"selected","click","mouseenter",4,"ngFor","ngForOf"],[1,"product-item",3,"click","mouseenter"],["class","item-image",3,"src",4,"ngIf"],["class","item-image",4,"ngIf"],[1,"item-details"],[1,"item-name"],[1,"item-meta"],[1,"item-prices"],[1,"item-price"],[1,"item-price-alt"],[1,"item-image",3,"src"],[1,"item-image"],["class","no-results",4,"ngIf"],[1,"no-results"]],template:function(n,t){if(n&1){let i=j();o(0,"div",2)(1,"div",3)(2,"div",4)(3,"mat-icon",5),a(4,"search"),r(),o(5,"input",6,0),G("ngModelChange",function(d){return S(i),Z(t.searchText,d)||(t.searchText=d),b(d)}),p("ngModelChange",function(d){return S(i),b(t.onSearch(d))})("keydown",function(d){return S(i),b(t.onKeyDown(d))}),r()()(),o(7,"div",7),C(8,Me,2,1,"div",8)(9,Oe,2,2,"ng-template",null,1,X),r()()}if(n&2){let i=Y(10);c(5),Q("ngModel",t.searchText),c(3),l("ngIf",t.filteredProducts.length>0)("ngIfElse",i)}},dependencies:[P,ee,te,M,se,le,de,D,I,T,ce,ie,ne],styles:[".search-container[_ngcontent-%COMP%]{display:flex;flex-direction:column;height:100%;background-color:#fff;overflow:hidden}.search-header[_ngcontent-%COMP%]{padding:16px;background-color:#fff;box-shadow:0 1px 3px #0000001a;z-index:10}.search-input-wrapper[_ngcontent-%COMP%]{position:relative;display:flex;align-items:center}.search-icon[_ngcontent-%COMP%]{position:absolute;left:12px;color:#666}.search-input-wrapper[_ngcontent-%COMP%]   input[_ngcontent-%COMP%]{width:100%;padding:12px 12px 12px 48px;font-size:1.2rem;border:2px solid #e0e0e0;border-radius:8px;outline:none;transition:border-color .2s}.search-input-wrapper[_ngcontent-%COMP%]   input[_ngcontent-%COMP%]:focus{border-color:#6200ee}.search-results[_ngcontent-%COMP%]{flex:1;overflow-y:auto;padding:16px}.product-list[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:8px}.product-item[_ngcontent-%COMP%]{display:flex;align-items:center;padding:10px;border:1px solid #eee;border-radius:8px;cursor:pointer;background-color:#fff;transition:all .2s}.product-item[_ngcontent-%COMP%]:hover, .product-item.selected[_ngcontent-%COMP%]{border-color:#6200ee;background-color:#f8f9fa;transform:translateY(-1px);box-shadow:0 2px 5px #0000000d}.product-item.selected[_ngcontent-%COMP%]{background-color:#f0ebff;border-color:#6200ee;border-width:2px}.item-image[_ngcontent-%COMP%]{width:60px;height:60px;border-radius:6px;object-fit:cover;margin-right:16px;background-color:#f5f5f5;border:1px solid #efefef;display:flex;align-items:center;justify-content:center;color:#ccc;flex-shrink:0}.item-details[_ngcontent-%COMP%]{flex:1}.item-name[_ngcontent-%COMP%]{font-weight:500;font-size:1rem;color:#333;margin-bottom:4px}.item-meta[_ngcontent-%COMP%]{display:flex;gap:16px;font-size:.9rem;color:#666}.item-prices[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:2px}.item-price[_ngcontent-%COMP%]{font-weight:600;color:#6200ee;line-height:1}.item-price-alt[_ngcontent-%COMP%]{font-size:.8rem;color:#888;font-weight:500}.no-results[_ngcontent-%COMP%]{display:flex;flex-direction:column;align-items:center;justify-content:center;height:200px;color:#888}.no-results[_ngcontent-%COMP%]   mat-icon[_ngcontent-%COMP%]{font-size:48px;width:48px;height:48px;margin-bottom:12px;color:#ccc}.search-results[_ngcontent-%COMP%]::-webkit-scrollbar{width:6px}.search-results[_ngcontent-%COMP%]::-webkit-scrollbar-track{background:transparent}.search-results[_ngcontent-%COMP%]::-webkit-scrollbar-thumb{background:#e0e0e0;border-radius:10px}"]})}return s})();export{Se as a,ht as b};
