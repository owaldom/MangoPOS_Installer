import{a as p}from"./chunk-DGQM6DPS.js";import{a as u}from"./chunk-YCMZOG5D.js";import{d as o}from"./chunk-3TNWXQYU.js";import{S as h,W as l,_ as r,f as s}from"./chunk-WSMHJDAT.js";import{a,b as c}from"./chunk-C6Q5SG76.js";var I=(()=>{class i{http;settingsService;apiUrl=`${u.apiUrl}/purchases`;STORAGE_KEY="mangopos_purchase_state";state=this.createEmptyState();currentLinesSubject=new s([]);currentLines$=this.currentLinesSubject.asObservable();selectedSupplierSubject=new s(null);selectedSupplier$=this.selectedSupplierSubject.asObservable();selectedLineIndexSubject=new s(-1);selectedLineIndex$=this.selectedLineIndexSubject.asObservable();globalDiscountSubject=new s(0);globalDiscount$=this.globalDiscountSubject.asObservable();exchangeRateSubject=new s(1);exchangeRate$=this.exchangeRateSubject.asObservable();purchaseStateSubject=new s(this.state);purchaseState$=this.purchaseStateSubject.asObservable();constructor(t,e){this.http=t,this.settingsService=e,this.loadFromStorage(),this.updateState()}createEmptyState(){return{id:Math.random().toString(36).substring(2,9),lines:[],selectedSupplier:null,selectedLineIndex:-1,notes:"",dateInvoice:new Date,globalDiscount:0,globalTaxId:0,globalTaxRate:0}}createPurchase(t){return this.http.post(this.apiUrl,t).pipe(h(()=>this.clearPurchase()))}createDebtPayment(t){return this.http.post(`${this.apiUrl}/debt-payment`,t)}getHistory(t){return this.http.get(`${this.apiUrl}/history`,{params:t})}getById(t){return this.http.get(`${this.apiUrl}/${t}`)}addLine(t){let e=this.state.lines.findIndex(n=>n.product_id===t.product_id);e>-1?this.state.lines[e].units+=t.units:this.state.lines.push(c(a({},t),{discount:t.discount||0})),this.state.selectedLineIndex=this.state.lines.length-1,this.updateState()}removeLine(t){this.state.lines.splice(t,1),this.state.selectedLineIndex>=this.state.lines.length&&(this.state.selectedLineIndex=this.state.lines.length-1),this.updateState()}updateLineQuantity(t,e){this.state.lines[t]&&(this.state.lines[t].units=e,this.state.lines[t].units<=0?this.removeLine(t):this.updateState())}updateLinePrice(t,e){this.state.lines[t]&&(this.state.lines[t].price=e,this.updateState())}updateLineDiscount(t,e){this.state.lines[t]&&(this.state.lines[t].discount=e,this.updateState())}updateLineTax(t,e,n){this.state.lines[t]&&(this.state.lines[t].taxid=e,this.state.lines[t].tax_rate=n,this.updateState())}setGlobalDiscount(t){this.state.globalDiscount=t,this.updateState()}setGlobalTax(t,e){this.state.globalTaxId=t,this.state.globalTaxRate=e,this.updateState()}setSelectedSupplier(t){this.state.selectedSupplier=t,this.selectedSupplierSubject.next(t),this.saveToStorage()}setSelectedLineIndex(t){this.state.selectedLineIndex=t,this.selectedLineIndexSubject.next(t),this.saveToStorage()}setInvoiceData(t){this.state=a(a({},this.state),t),this.updateState()}clearPurchase(){this.state=this.createEmptyState(),this.updateState()}updateState(){this.currentLinesSubject.next([...this.state.lines]),this.selectedSupplierSubject.next(this.state.selectedSupplier),this.selectedLineIndexSubject.next(this.state.selectedLineIndex),this.globalDiscountSubject.next(this.state.globalDiscount),this.purchaseStateSubject.next(a({},this.state)),this.saveToStorage()}saveToStorage(){localStorage.setItem(this.STORAGE_KEY,JSON.stringify(this.state))}loadFromStorage(){let t=localStorage.getItem(this.STORAGE_KEY);if(t)try{this.state=JSON.parse(t)}catch{this.state=this.createEmptyState()}}setExchangeRate(t){this.exchangeRateSubject.next(t)}static \u0275fac=function(e){return new(e||i)(r(o),r(p))};static \u0275prov=l({token:i,factory:i.\u0275fac,providedIn:"root"})}return i})();export{I as a};
