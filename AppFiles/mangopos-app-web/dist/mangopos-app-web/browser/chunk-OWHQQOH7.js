import{a as pt}from"./chunk-44A6ZDZO.js";import{a as v,b as A}from"./chunk-R7JIR2Y5.js";import{a as mt,b as ct,c as lt}from"./chunk-HCWDTVFW.js";import{a as at}from"./chunk-5MBFWMTP.js";import{a as Oe}from"./chunk-7KQW3R3P.js";import{b as Le,c as Je}from"./chunk-HIZ742YJ.js";import{a as Re}from"./chunk-XGFVHFBN.js";import{a as rt}from"./chunk-RFRKPPY3.js";import{a as tt,c as N,e as ot,f as it,g as nt,h as V}from"./chunk-Z6YHTX75.js";import{a as pe,b as de}from"./chunk-26KDQVR5.js";import{a as B}from"./chunk-DGQM6DPS.js";import{a as Ie}from"./chunk-SCPRHZYR.js";import{a as Xe,b as Ye,c as Ze,d as et}from"./chunk-N7P7XLP2.js";import{d as ce}from"./chunk-GRESZPIF.js";import"./chunk-EQXJNMRX.js";import{b as De,c as Te}from"./chunk-APXOZHQA.js";import{a as Be,b as Ne,c as Ve,d as Ae,e as qe,f as Ue,g as $e,h as ze,i as He,j as Ke,l as je,m as We}from"./chunk-VJGP4MMT.js";import{a as Ge,b as Qe}from"./chunk-VNZMNOUU.js";import"./chunk-YCMZOG5D.js";import{a as ye,h as xe}from"./chunk-ZWM7H6SC.js";import{a as Fe}from"./chunk-PALJ6VDH.js";import"./chunk-TEMJ73U5.js";import{d as me}from"./chunk-52A733DE.js";import"./chunk-GPHRSLLH.js";import{b as ke,f as we,i as Pe,j as Ee}from"./chunk-EWTXOCXT.js";import{b as se,d as x,f as ue,g as fe,j as ge,k as he,n as Se,o as _e,u as Me,w as ve,x as Ce,y as be}from"./chunk-AVLO2MYP.js";import{a as O,b as R}from"./chunk-JI7GBIO6.js";import"./chunk-VTP6RNFS.js";import{I as F,J as le,K as I}from"./chunk-M7DMR53X.js";import"./chunk-JAVK727W.js";import"./chunk-3TNWXQYU.js";import"./chunk-UWUK32S4.js";import{k as ne,l as re,s as ae,u as D,v as T}from"./chunk-ZD4QWOHN.js";import{$ as d,$b as L,D as U,Fb as p,G as K,Gb as r,Hb as n,Ib as _,Mb as C,Nb as b,P as j,Pb as G,Q as W,Ub as f,Wa as m,Wb as k,_b as Q,ac as J,e as q,ea as h,ec as $,fa as S,gc as X,ic as a,j as H,jb as P,jc as z,kc as M,lc as E,nc as Y,oc as Z,pb as s,pc as ee,sc as te,vc as y,wc as oe,xc as ie,zc as w}from"./chunk-WSMHJDAT.js";import"./chunk-C6Q5SG76.js";var ht=["barcodeInput"],St=()=>({standalone:!0});function _t(i,c){if(i&1&&(r(0,"mat-option",29),a(1),n()),i&2){let e=c.$implicit;p("value",e.id),m(),M(" ",e.name," ")}}function Mt(i,c){if(i&1&&(r(0,"mat-option",29),a(1),n()),i&2){let e=c.$implicit;p("value",e),m(),E(" ",e.name," (",e.sign>0?"Entrada":"Salida",") ")}}function vt(i,c){if(i&1&&(r(0,"mat-option",29),a(1),n()),i&2){let e=c.$implicit;p("value",e),m(),E(" ",e.name," (",e.reference,") ")}}function Ct(i,c){if(i&1&&(r(0,"div",30)(1,"p")(2,"strong"),a(3,"Producto: "),n(),a(4),n(),r(5,"p")(6,"strong"),a(7,"Precio Compra / Venta: "),n(),a(8),y(9,"currency"),y(10,"currency"),n()()),i&2){let e=k();m(4),M(" ",e.selectedProduct.name),m(4),E(" ",w(9,3,e.selectedProduct.pricebuy,"USD","$ ",e.settingsService.getDecimalFormat("price"))," / ",w(10,8,e.selectedProduct.pricesell,"USD","$ ",e.settingsService.getDecimalFormat("price"))," ")}}var dt=(()=>{class i{form;locations=[];reasons=v.getAll();filteredProducts=[];selectedProduct=null;fb=d(ve);stockService=d(A);productService=d(at);dialogRef=d(tt);dialog=d(N);snackBar=d(pe);settingsService=d(B);configService=d(Oe);barcode="";barcodeInput;barcodeSubject=new q;destroy$=new q;constructor(){this.form=this.fb.group({date:[new Date,x.required],location:[null,x.required],reason:[this.reasons[0],x.required],productSearch:[""],units:[1,[x.required,x.min(.001)]],price:[0,x.required],concept:[""]})}ngOnInit(){this.stockService.getLocations().subscribe(e=>{let t=this.configService.getConfig();t?.installation_type==="pos"?this.locations=e.filter(o=>o.name===t.location_name):this.locations=e.filter(o=>o.type==="factory"),this.locations.length>0&&this.form.patchValue({location:this.locations[0].id})}),setTimeout(()=>this.focusBarcode(),500),this.barcodeSubject.pipe(U(400),W(this.destroy$)).subscribe(e=>{e&&e.length>=3&&this.processBarcode(e)}),this.form.get("productSearch")?.valueChanges.pipe(U(300),K(),j(e=>typeof e=="string"&&e.length>2?this.productService.getAll(1,10,{search:e}):H({data:[]}))).subscribe(e=>{this.filteredProducts=e.data})}ngOnDestroy(){this.destroy$.next(),this.destroy$.complete()}displayProduct(e){return e&&e.name?e.name:""}onProductSelected(e){let t=e.option.value;if(t.typeproduct==="KI"||t.typeproduct==="CO"||!!(t.servicio&&t.servicio!=="0"&&t.servicio!==!1)){this.snackBar.open("No se permite gestionar stock para este tipo de producto (Kit, Compuesto o Servicio)","Cerrar",{duration:4e3}),this.selectedProduct=null,this.form.patchValue({productSearch:""});return}this.selectedProduct=t,this.updatePriceSuggestion()}openProductSelector(){this.dialog.open(pt,{width:"1100px",height:"800px",maxWidth:"95vw",data:{locationId:this.form.get("location")?.value}}).afterClosed().subscribe(t=>{if(t){let o=t;if(o.typeproduct==="KI"||o.typeproduct==="CO"||!!(o.servicio&&o.servicio!=="0"&&o.servicio!==!1)){this.snackBar.open("No se permite gestionar stock para este tipo de producto (Kit, Compuesto o Servicio)","Cerrar",{duration:4e3});return}this.selectedProduct=o,this.form.patchValue({productSearch:o}),this.updatePriceSuggestion()}})}onBarcodeEnter(e){let t=e.target.value?.trim();if(!t){this.barcode="";return}this.processBarcode(t)}onBarcodeChange(e){let t=e?.trim();t&&this.barcodeSubject.next(t)}processBarcode(e){this.productService.getAll(1,1,{search:e}).subscribe(t=>{if(t.data&&t.data.length>0){let o=t.data.find(l=>l.code===e||l.reference===e)||t.data[0];if(o.code===e||o.reference===e){if(o.typeproduct==="KI"||o.typeproduct==="CO"||!!(o.servicio&&o.servicio!=="0"&&o.servicio!==!1)){this.snackBar.open(`No se permite gestionar stock para "${o.name}" (Kit, Compuesto o Servicio)`,"Cerrar",{duration:4e3}),this.barcode="";return}this.selectedProduct=o,this.form.patchValue({productSearch:o}),this.updatePriceSuggestion(),this.barcode=""}else this.barcode=""}else this.barcode=""})}focusBarcode(){this.barcodeInput&&this.barcodeInput.nativeElement.focus()}onReasonChange(){this.updatePriceSuggestion()}updatePriceSuggestion(){if(!this.selectedProduct)return;let e=this.form.get("reason")?.value,t=0;e.key===v.IN_PURCHASE.key||e.key===v.OUT_REFUND.key||e.key===v.OUT_BREAK.key||e.key===v.OUT_CONSUMPTION.key?t=this.selectedProduct.pricebuy:t=this.selectedProduct.pricesell,this.form.patchValue({price:t})}onSubmit(){if(this.form.valid&&this.selectedProduct){let e=this.form.value,t=e.reason,o=e.units*t.sign,l={date:e.date,location:e.location,reason:t.key,product:this.selectedProduct.id,units:o,price:e.price,concept:e.concept};this.dialogRef.close(l)}}static \u0275fac=function(t){return new(t||i)};static \u0275cmp=P({type:i,selectors:[["app-stock-movement-form"]],viewQuery:function(t,o){if(t&1&&Q(ht,5),t&2){let l;L(l=J())&&(o.barcodeInput=l.first)}},decls:57,vars:13,consts:[["picker",""],["auto","matAutocomplete"],["barcodeInput",""],["mat-dialog-title",""],[3,"ngSubmit","formGroup"],[1,"dialog-content"],[1,"row"],["appearance","outline",1,"half-width"],["matInput","","formControlName","date","required","",3,"matDatepicker"],["matIconSuffix","",3,"for"],["formControlName","location","required",""],[3,"value",4,"ngFor","ngForOf"],["appearance","outline",1,"full-width"],["formControlName","reason","required","",3,"selectionChange"],[1,"row","full-width-field"],["appearance","outline",1,"flex-grow"],["type","text","matInput","","formControlName","productSearch",3,"matAutocomplete"],[3,"optionSelected","displayWith"],[1,"barcode-container"],[1,"barcode-icon"],["type","text","placeholder","Escanea...",1,"barcode-input",3,"ngModelChange","keyup.enter","ngModel","ngModelOptions"],["mat-mini-fab","","color","primary","type","button","matTooltip","B\xFAsqueda avanzada",1,"search-btn",3,"click"],["class","product-info",4,"ngIf"],["matInput","","type","text","formControlName","units","required","","appMoneyInput","","decimalType","quantity"],["matInput","","type","text","formControlName","price","required","","appMoneyInput","","decimalType","price"],["matInput","","formControlName","concept"],["align","end"],["mat-button","","type","button",3,"click"],["mat-flat-button","","color","primary","type","submit",3,"disabled"],[3,"value"],[1,"product-info"]],template:function(t,o){if(t&1){let l=G();r(0,"h2",3),a(1,"Nuevo Movimiento de Stock"),n(),r(2,"form",4),f("ngSubmit",function(){return h(l),S(o.onSubmit())}),r(3,"mat-dialog-content",5)(4,"div",6)(5,"mat-form-field",7)(6,"mat-label"),a(7,"Fecha"),n(),_(8,"input",8)(9,"mat-datepicker-toggle",9)(10,"mat-datepicker",null,0),n(),r(12,"mat-form-field",7)(13,"mat-label"),a(14,"Almac\xE9n"),n(),r(15,"mat-select",10),s(16,_t,2,2,"mat-option",11),n()()(),r(17,"mat-form-field",12)(18,"mat-label"),a(19,"Tipo de Movimiento"),n(),r(20,"mat-select",13),f("selectionChange",function(){return h(l),S(o.onReasonChange())}),s(21,Mt,2,3,"mat-option",11),n()(),r(22,"div",14)(23,"mat-form-field",15)(24,"mat-label"),a(25,"Buscar Producto (Nombre o C\xF3digo)"),n(),_(26,"input",16),r(27,"mat-autocomplete",17,1),f("optionSelected",function(g){return h(l),S(o.onProductSelected(g))}),s(29,vt,2,3,"mat-option",11),n()(),r(30,"div",18)(31,"mat-icon",19),a(32,"qr_code_scanner"),n(),r(33,"input",20,2),ee("ngModelChange",function(g){return h(l),Z(o.barcode,g)||(o.barcode=g),S(g)}),f("ngModelChange",function(g){return h(l),S(o.onBarcodeChange(g))})("keyup.enter",function(g){return h(l),S(o.onBarcodeEnter(g))}),n()(),r(35,"button",21),f("click",function(){return h(l),S(o.openProductSelector())}),r(36,"mat-icon"),a(37,"search"),n()()(),s(38,Ct,11,13,"div",22),r(39,"div",6)(40,"mat-form-field",7)(41,"mat-label"),a(42,"Unidades"),n(),_(43,"input",23),n(),r(44,"mat-form-field",7)(45,"mat-label"),a(46,"Precio (Unitario)"),n(),_(47,"input",24),n()(),r(48,"mat-form-field",12)(49,"mat-label"),a(50,"Concepto / Notas"),n(),_(51,"input",25),n()(),r(52,"mat-dialog-actions",26)(53,"button",27),f("click",function(){return h(l),S(o.dialogRef.close())}),a(54,"Cancelar"),n(),r(55,"button",28),a(56,"Registrar"),n()()()}if(t&2){let l=$(11),u=$(28);m(2),p("formGroup",o.form),m(6),p("matDatepicker",l),m(),p("for",l),m(7),p("ngForOf",o.locations),m(5),p("ngForOf",o.reasons),m(5),p("matAutocomplete",u),m(),p("displayWith",o.displayProduct),m(2),p("ngForOf",o.filteredProducts),m(4),Y("ngModel",o.barcode),p("ngModelOptions",te(12,St)),m(5),p("ngIf",o.selectedProduct),m(17),p("disabled",o.form.invalid||!o.selectedProduct)}},dependencies:[T,ne,re,Ce,he,se,ue,fe,Me,ge,be,_e,Se,V,ot,nt,it,Ee,Pe,ke,we,Te,De,I,F,le,Qe,Ge,me,lt,mt,ct,et,Xe,Ye,Ze,ce,R,O,Ie,Fe,de,rt,D],styles:[".dialog-content[_ngcontent-%COMP%]{min-width:1000px;display:flex;flex-direction:column;gap:10px;padding-top:10px}.row[_ngcontent-%COMP%]{display:flex;gap:16px;align-items:baseline}.full-width[_ngcontent-%COMP%]{width:100%}.half-width[_ngcontent-%COMP%]{width:50%}.flex-grow[_ngcontent-%COMP%]{flex:1}.full-width-field[_ngcontent-%COMP%]{width:100%}.search-btn[_ngcontent-%COMP%]{margin-top:4px}.product-info[_ngcontent-%COMP%]{background:#f5f5f5;padding:10px;border-radius:4px;margin-bottom:10px}.barcode-container[_ngcontent-%COMP%]{display:flex;align-items:center;background:#f0f2f5;border-radius:8px;padding:4px 12px;border:1px solid #ddd;box-shadow:inset 0 1px 3px #0000000d;transition:all .3s ease;width:150px;height:40px}.barcode-container[_ngcontent-%COMP%]:focus-within{border-color:#6200ee;background:#fff}.barcode-icon[_ngcontent-%COMP%]{font-size:20px;width:20px;height:20px;color:#666;margin-right:8px}.barcode-input[_ngcontent-%COMP%]{border:none;background:transparent;outline:none;width:100%;font-size:.85rem;color:#333}"]})}return i})();function bt(i,c){i&1&&(r(0,"th",17),a(1," Fecha "),n())}function yt(i,c){if(i&1&&(r(0,"td",18),a(1),y(2,"systemDate"),n()),i&2){let e=c.$implicit;m(),M(" ",oe(2,1,e.datenew)," ")}}function xt(i,c){i&1&&(r(0,"th",17),a(1," Almac\xE9n "),n())}function kt(i,c){if(i&1&&(r(0,"td",18),a(1),n()),i&2){let e=c.$implicit;m(),M(" ",e.location_name," ")}}function wt(i,c){i&1&&(r(0,"th",17),a(1," Producto "),n())}function Pt(i,c){if(i&1&&(r(0,"td",18)(1,"span",19),a(2),n(),r(3,"span",20),a(4),n()()),i&2){let e=c.$implicit;m(2),z(e.product_name),m(2),z(e.product_reference)}}function Et(i,c){i&1&&(r(0,"th",17),a(1," Motivo "),n())}function Dt(i,c){if(i&1&&(r(0,"td",18),a(1),n()),i&2){let e=c.$implicit,t=k();m(),M(" ",t.getReasonName(e.reason)," ")}}function Tt(i,c){i&1&&(r(0,"th",17),a(1," Unidades "),n())}function Ft(i,c){if(i&1&&(r(0,"td",18),a(1),y(2,"number"),n()),i&2){let e=c.$implicit,t=k();X("negative",e.units<0)("positive",e.units>0),m(),M(" ",ie(2,5,e.units,t.settingsService.getDecimalFormat("quantity"))," ")}}function It(i,c){i&1&&(r(0,"th",17),a(1," Precio "),n())}function Ot(i,c){if(i&1&&(r(0,"td",18),a(1),y(2,"currency"),n()),i&2){let e=c.$implicit,t=k();m(),M(" ",w(2,1,e.price,"USD","$ ",t.settingsService.getDecimalFormat("price"))," ")}}function Rt(i,c){i&1&&_(0,"tr",21)}function Bt(i,c){i&1&&_(0,"tr",22)}var Ro=(()=>{class i{displayedColumns=["date","location","product","reason","units","price"];dataSource=new We([]);totalElements=0;pageSize=50;stockService=d(A);dialog=d(N);settingsService=d(B);ngOnInit(){this.loadMovements(1)}loadMovements(e){this.stockService.getMovements(e,this.pageSize).subscribe(t=>{this.dataSource.data=t.data,this.totalElements=t.total})}onPageChange(e){this.pageSize=e.pageSize,this.loadMovements(e.pageIndex+1)}openForm(){this.dialog.open(dt,{width:"1000px",maxWidth:"95vw"}).afterClosed().subscribe(t=>{t&&this.stockService.createMovement(t).subscribe({next:()=>{this.loadMovements(1)},error:o=>alert("Error: "+o.error.error)})})}getReasonName(e){let t=v.getAll().find(o=>o.key===e);return t?t.name:"Desconocido"}static \u0275fac=function(t){return new(t||i)};static \u0275cmp=P({type:i,selectors:[["app-stock-movements"]],decls:32,vars:5,consts:[[1,"container"],[1,"header"],["mat-flat-button","","color","primary",3,"click"],[1,"table-container"],["mat-table","",3,"dataSource"],["matColumnDef","date"],["mat-header-cell","",4,"matHeaderCellDef"],["mat-cell","",4,"matCellDef"],["matColumnDef","location"],["matColumnDef","product"],["matColumnDef","reason"],["matColumnDef","units"],["mat-cell","",3,"negative","positive",4,"matCellDef"],["matColumnDef","price"],["mat-header-row","",4,"matHeaderRowDef"],["mat-row","",4,"matRowDef","matRowDefColumns"],[3,"page","length","pageSize"],["mat-header-cell",""],["mat-cell",""],[1,"product-name"],[1,"product-ref"],["mat-header-row",""],["mat-row",""]],template:function(t,o){t&1&&(r(0,"div",0)(1,"div",1)(2,"h1"),a(3,"Movimientos de Stock (Kardex)"),n(),r(4,"button",2),f("click",function(){return o.openForm()}),r(5,"mat-icon"),a(6,"add"),n(),a(7," Nuevo Movimiento "),n()(),r(8,"mat-card")(9,"div",3)(10,"table",4),C(11,5),s(12,bt,2,0,"th",6)(13,yt,3,3,"td",7),b(),C(14,8),s(15,xt,2,0,"th",6)(16,kt,2,1,"td",7),b(),C(17,9),s(18,wt,2,0,"th",6)(19,Pt,5,2,"td",7),b(),C(20,10),s(21,Et,2,0,"th",6)(22,Dt,2,1,"td",7),b(),C(23,11),s(24,Tt,2,0,"th",6)(25,Ft,3,8,"td",12),b(),C(26,13),s(27,It,2,0,"th",6)(28,Ot,3,6,"td",7),b(),s(29,Rt,1,0,"tr",14)(30,Bt,1,0,"tr",15),n()(),r(31,"app-shared-paginator",16),f("page",function(u){return o.onPageChange(u)}),n()()()),t&2&&(m(10),p("dataSource",o.dataSource),m(19),p("matHeaderRowDef",o.displayedColumns),m(),p("matRowDefColumns",o.displayedColumns),m(),p("length",o.totalElements)("pageSize",o.pageSize))},dependencies:[T,je,Be,Ve,$e,Ae,Ne,ze,qe,Ue,He,Ke,Le,Je,I,F,R,O,xe,ye,V,ae,D,Re],styles:[".container[_ngcontent-%COMP%]{padding:20px}.header[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}.table-container[_ngcontent-%COMP%]{overflow-x:auto}.product-name[_ngcontent-%COMP%]{display:block;font-weight:500}.product-ref[_ngcontent-%COMP%]{display:block;font-size:.8em;color:#666}.negative[_ngcontent-%COMP%]{color:#d32f2f;font-weight:700}.positive[_ngcontent-%COMP%]{color:#388e3c;font-weight:700}"]})}return i})();export{Ro as StockMovementsComponent};
