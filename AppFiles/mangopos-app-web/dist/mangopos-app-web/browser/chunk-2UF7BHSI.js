import{a as d}from"./chunk-DGQM6DPS.js";import{d as m}from"./chunk-3TNWXQYU.js";import{$ as l,B as i,W as u,_ as h,j as a,k as p,o as s,p as c}from"./chunk-WSMHJDAT.js";var U=(()=>{class o{http;_baseUrlOverride=null;get baseUrl(){return this._baseUrlOverride?this._baseUrlOverride:this.settingsService.getSettings()?.print_server_url||"http://localhost:3001/api"}requestTimeout=1e4;settingsService=l(d);constructor(t){this.http=t}setBackendUrl(t){this._baseUrlOverride=t}getBackendUrl(){return this.baseUrl}testConnection(){return this.http.get(`${this.baseUrl}/print/test`).pipe(s(this.requestTimeout),i(this.handleError))}testPrinter(t,r=80){let e={printerName:t,width:r};return this.http.post(`${this.baseUrl}/print/test`,e).pipe(s(this.requestTimeout),i(this.handleError))}getPrinterSettings(){return this.http.get(`${this.baseUrl}/settings`).pipe(s(this.requestTimeout),i(this.handleError))}savePrinterSettings(t){return this.http.post(`${this.baseUrl}/settings`,t).pipe(s(this.requestTimeout),i(this.handleError))}printTicket(t,r="TICKET"){let e={ticket:this.formatTicketForPrinter(t),docType:r};return this.http.post(`${this.baseUrl}/print/ticket`,e).pipe(s(this.requestTimeout),i(this.handleError))}openCashDrawer(){return this.http.post(`${this.baseUrl}/print/open-drawer`,{}).pipe(s(this.requestTimeout),i(this.handleError))}isBackendAvailable(){let t=this.baseUrl.replace("/api","");return this.http.get(t,{responseType:"text"}).pipe(s(3e3),c(()=>!0),i(()=>a(!1)))}getPrinters(){return this.http.get(`${this.baseUrl}/print`).pipe(s(this.requestTimeout),i(this.handleError))}formatTicketForPrinter(t){let r=this.settingsService.getSettings();return{company_name:r?.company_name||"MANGOPOS",company_address:r?.company_address||"",company_phone:"",company_tax_id:"",ticket_number:t.ticket_number,date:t.date,cashier_name:t.cashier_name,customer_name:t.customer_name||"P\xFAblico General",notes:t.notes||"",lines:(t.lines||[]).map(e=>({product_name:e.product_name,units:e.units,price:e.price,discount:e.discount||0,discount_type:e.discount_type||"PERCENT",total:e.total})),subtotal:this.calculateSubtotal(t),taxes:t.taxes||[],globalDiscount:t.globalDiscount||0,globalDiscountType:t.globalDiscountType||"PERCENT",total:t.total,exchange_rate:t.exchange_rate,payments:t.payments||[]}}calculateSubtotal(t){return(t.lines||[]).reduce((r,e)=>{let n=e.price;return e.discount&&(e.discount_type==="FIXED"?n=Math.max(0,e.price-e.discount):e.discount_type==="FIXED_VES"?n=Math.max(0,e.price-e.discount/t.exchange_rate):n=e.price*(1-e.discount)),r+e.units*n},0)}handleError(t){let r="Error desconocido";return t.error instanceof ErrorEvent?r=`Error: ${t.error.message}`:t.status===0?r="No se pudo conectar con el servidor de impresi\xF3n. Verifique que est\xE9 corriendo.":t.status===503?r="Impresora no disponible. Verifique la conexi\xF3n USB.":r=t.error?.error||`Error del servidor: ${t.status}`,p(()=>({success:!1,error:r}))}static \u0275fac=function(r){return new(r||o)(h(m))};static \u0275prov=u({token:o,factory:o.\u0275fac,providedIn:"root"})}return o})();export{U as a};
