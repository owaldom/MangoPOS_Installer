import{a as Qe}from"./chunk-CN4LGAMC.js";import"./chunk-R3L57XND.js";import"./chunk-NL74O3Y5.js";import{a as te}from"./chunk-Y6WNQBHI.js";import{a as Ee}from"./chunk-HYURECNX.js";import"./chunk-2UF7BHSI.js";import{b as Ne,c as We}from"./chunk-HIZ742YJ.js";import{a as W}from"./chunk-XGFVHFBN.js";import"./chunk-TW2J4ZKO.js";import"./chunk-UPZQJ6EF.js";import{a as Ye,b as Je}from"./chunk-XEWEKXFC.js";import{a as Ke}from"./chunk-RFRKPPY3.js";import{a as ve,b as De,c as Ze,e as ye,f as ke,g as be,h as ee}from"./chunk-Z6YHTX75.js";import{a as A,b as re}from"./chunk-26KDQVR5.js";import{a as $e}from"./chunk-DGQM6DPS.js";import"./chunk-SCPRHZYR.js";import{a as je,b as ze,c as Ge,d as qe}from"./chunk-N7P7XLP2.js";import{a as U,b as N}from"./chunk-N5ZCCEPE.js";import{d as Ve}from"./chunk-GRESZPIF.js";import"./chunk-EQXJNMRX.js";import{b as Me,c as Se}from"./chunk-APXOZHQA.js";import{a as $,b as j,c as z,d as G,e as q,f as Z,g as Y,h as J,i as K,j as Q,l as X}from"./chunk-VJGP4MMT.js";import{a as Le,b as Ue}from"./chunk-VNZMNOUU.js";import"./chunk-YCMZOG5D.js";import{a as pe,b as ue,c as fe,f as _e,h as ge}from"./chunk-ZWM7H6SC.js";import"./chunk-PALJ6VDH.js";import"./chunk-TEMJ73U5.js";import{d as Re}from"./chunk-52A733DE.js";import"./chunk-GPHRSLLH.js";import{b as Ce,e as Ae,f as He,i as xe,j as he}from"./chunk-EWTXOCXT.js";import{b as le,f as me,j as ce,l as de,s as Be,t as Fe,x as se}from"./chunk-AVLO2MYP.js";import{a as H,b as L}from"./chunk-JI7GBIO6.js";import"./chunk-VTP6RNFS.js";import{H as Oe,I as B,K as F}from"./chunk-M7DMR53X.js";import"./chunk-JAVK727W.js";import"./chunk-3TNWXQYU.js";import"./chunk-UWUK32S4.js";import{k as Pe,l as V,s as oe,u as Ie,v as O}from"./chunk-ZD4QWOHN.js";import{$ as S,Fb as c,Gb as n,Hb as i,Ib as D,Mb as g,Nb as C,Pb as b,Ub as v,Wa as r,Wb as p,ea as x,ec as Te,fa as h,hc as ae,ic as a,jb as P,jc as f,kc as u,nc as E,oc as T,pb as s,pc as w,sc as we,vc as _,wc as I,xc as y,zc as R}from"./chunk-WSMHJDAT.js";import{a as ie,b as ne}from"./chunk-C6Q5SG76.js";var ct=()=>[];function dt(t,l){t&1&&D(0,"mat-spinner",7)}function st(t,l){if(t&1&&(n(0,"div",11)(1,"strong"),a(2,"C\xE9dula/RIF:"),i(),n(3,"span"),a(4),i()()),t&2){let e=p(2);r(4),f(e.ticket.customer_taxid)}}function pt(t,l){if(t&1&&(n(0,"div",36)(1,"strong"),a(2,"Notas:"),i(),n(3,"span",37),a(4),i()()),t&2){let e=p(2);r(4),f(e.ticket.notes)}}function ut(t,l){t&1&&(n(0,"th",38),a(1,"Producto"),i())}function ft(t,l){if(t&1&&(n(0,"td",39)(1,"div",40)(2,"strong"),a(3),i(),n(4,"small"),a(5),i()()()),t&2){let e=l.$implicit;r(3),f(e.product_name),r(2),f(e.product_reference)}}function _t(t,l){t&1&&(n(0,"th",38),a(1,"Cantidad"),i())}function gt(t,l){if(t&1&&(n(0,"td",39),a(1),_(2,"number"),i()),t&2){let e=l.$implicit,m=p(2);r(),f(y(2,1,e.units,m.quantityFormat))}}function Ct(t,l){t&1&&(n(0,"th",41),a(1,"Precio Unit."),i())}function xt(t,l){if(t&1&&(n(0,"td",42),a(1),_(2,"number"),i()),t&2){let e=l.$implicit,m=p(2);r(),u("Bs. ",y(2,1,e.price*(m.ticket.exchange_rate||1),"1.2-2"))}}function ht(t,l){t&1&&(n(0,"th",41),a(1,"IVA"),i())}function Mt(t,l){if(t&1&&(n(0,"td",42),a(1),_(2,"number"),i()),t&2){let e=l.$implicit,m=p(2);r(),u("Bs. ",y(2,1,e.tax_amount*(m.ticket.exchange_rate||1),"1.2-2"))}}function St(t,l){t&1&&(n(0,"th",41),a(1,"Total"),i())}function vt(t,l){if(t&1&&(n(0,"td",43),a(1),_(2,"number"),i()),t&2){let e=l.$implicit,m=p(2);r(),u(" Bs. ",y(2,1,e.total*(m.ticket.exchange_rate||1),"1.2-2")," ")}}function Dt(t,l){t&1&&D(0,"tr",44)}function yt(t,l){t&1&&D(0,"tr",45)}function kt(t,l){if(t&1&&(n(0,"div",30)(1,"span"),a(2),i(),n(3,"strong"),a(4),_(5,"number"),i()()),t&2){let e=l.$implicit,m=p(2);r(2),u("IVA (",(e.percentage*100).toFixed(0),"%):"),r(2),u("Bs. ",y(5,2,e.amount*(m.ticket.exchange_rate||1),"1.2-2"))}}function bt(t,l){if(t&1&&(n(0,"small",48),a(1),_(2,"number"),i()),t&2){let e=p(3);r(),u("$ ",y(2,1,e.ticket.igtf_amount_alt,"1.2-2"))}}function Et(t,l){if(t&1&&(n(0,"div",30)(1,"span"),a(2,"I.G.T.F. (3%):"),i(),n(3,"div",46),s(4,bt,3,4,"small",47),n(5,"strong"),a(6),_(7,"number"),i()()()),t&2){let e=p(2);r(4),c("ngIf",e.ticket.igtf_amount_alt),r(2),u("Bs. ",y(7,2,(e.ticket.igtf_amount||0)*(e.ticket.exchange_rate||1),"1.2-2"))}}function Tt(t,l){if(t&1&&(n(0,"small"),a(1),i()),t&2){let e=p(2).$implicit;r(),u("Banco: ",e.bank)}}function wt(t,l){if(t&1&&(n(0,"small"),a(1),i()),t&2){let e=p(2).$implicit;r(),u("Ref: ",e.reference)}}function Pt(t,l){if(t&1&&(n(0,"small"),a(1),i()),t&2){let e=p(2).$implicit;r(),u("C.I/RIF: ",e.cedula)}}function It(t,l){if(t&1&&(n(0,"div",52),s(1,Tt,2,1,"small",53)(2,wt,2,1,"small",53)(3,Pt,2,1,"small",53),i()),t&2){let e=p().$implicit;r(),c("ngIf",e.bank),r(),c("ngIf",e.reference),r(),c("ngIf",e.cedula)}}function Rt(t,l){if(t&1&&(n(0,"div",49)(1,"div",50)(2,"span"),a(3),i(),n(4,"strong"),a(5),_(6,"number"),i()(),s(7,It,4,3,"div",51),i()),t&2){let e=l.$implicit,m=p(2);r(3),f(m.getPaymentMethodName(e.payment)),r(2),u("Bs. ",y(6,3,e.amount_base_currency||e.total*(m.ticket.exchange_rate||1),"1.2-2")),r(2),c("ngIf",e.reference||e.bank)}}function Vt(t,l){if(t&1&&(n(0,"div",8)(1,"mat-card",9)(2,"mat-card-header")(3,"mat-card-title"),a(4,"Informaci\xF3n General"),i()(),n(5,"mat-card-content")(6,"div",10)(7,"div",11)(8,"strong"),a(9,"Fecha:"),i(),n(10,"span"),a(11),_(12,"systemDate"),i()(),n(13,"div",11)(14,"strong"),a(15,"Tipo:"),i(),n(16,"span"),a(17),i()(),n(18,"div",11)(19,"strong"),a(20,"Cliente:"),i(),n(21,"span"),a(22),i()(),s(23,st,5,1,"div",12),n(24,"div",11)(25,"strong"),a(26,"Cajero:"),i(),n(27,"span"),a(28),i()(),n(29,"div",11)(30,"strong"),a(31,"Estado:"),i(),n(32,"span"),a(33),i()(),s(34,pt,5,1,"div",13),i()()(),n(35,"mat-card",14)(36,"mat-card-header")(37,"mat-card-title"),a(38,"Productos"),i()(),n(39,"mat-card-content")(40,"table",15),g(41,16),s(42,ut,2,0,"th",17)(43,ft,6,2,"td",18),C(),g(44,19),s(45,_t,2,0,"th",17)(46,gt,3,4,"td",18),C(),g(47,20),s(48,Ct,2,0,"th",21)(49,xt,3,4,"td",22),C(),g(50,23),s(51,ht,2,0,"th",21)(52,Mt,3,4,"td",22),C(),g(53,24),s(54,St,2,0,"th",21)(55,vt,3,4,"td",25),C(),s(56,Dt,1,0,"tr",26)(57,yt,1,0,"tr",27),i()()(),n(58,"mat-card",28)(59,"mat-card-header")(60,"mat-card-title"),a(61,"Resumen"),i()(),n(62,"mat-card-content")(63,"div",29)(64,"div",30)(65,"span"),a(66,"Subtotal:"),i(),n(67,"strong"),a(68),_(69,"number"),i()(),s(70,kt,6,5,"div",31)(71,Et,8,5,"div",32),n(72,"div",33)(73,"span"),a(74,"TOTAL:"),i(),n(75,"strong"),a(76),_(77,"number"),i()()(),n(78,"div",34)(79,"h4"),a(80,"M\xE9todos de Pago"),i(),s(81,Rt,8,6,"div",35),i()()()()),t&2){let e=p();r(11),f(I(12,17,e.ticket.date)),r(5),ae("ticket-type type-"+e.ticket.tickettype),r(),u(" ",e.ticket.tickettype===0?"Venta":"Devoluci\xF3n"," "),r(5),f(e.ticket.customer_name||"P\xFAblico General"),r(),c("ngIf",e.ticket.customer_taxid),r(5),f(e.ticket.cashier_name),r(5),f(e.ticket.status===0?"Completado":"Pendiente"),r(),c("ngIf",e.ticket.notes),r(6),c("dataSource",e.ticket.lines||we(25,ct)),r(16),c("matHeaderRowDef",e.lineColumns),r(),c("matRowDefColumns",e.lineColumns),r(11),u("Bs. ",y(69,19,e.calculateSubtotal()*(e.ticket.exchange_rate||1),"1.2-2")),r(2),c("ngForOf",e.ticket.taxes),r(),c("ngIf",(e.ticket.igtf_amount||0)>0),r(5),u("Bs. ",y(77,22,e.calculateTotal()*(e.ticket.exchange_rate||1),"1.2-2")),r(5),c("ngForOf",e.ticket.payments)}}var ot=(()=>{class t{salesHistoryService=S(te);dialogRef=S(ve);printService=S(Ee);data=S(De);settingsService=S($e);snackBar=S(A);ticket=null;loading=!0;lineColumns=["product","units","price","tax","total"];isPrinting=!1;quantityFormat="1.3-3";constructor(){this.quantityFormat=this.settingsService.getDecimalFormat("quantity")}ngOnInit(){this.loadTicketDetails()}loadTicketDetails(){this.salesHistoryService.getTicketById(this.data.ticketId).subscribe({next:e=>{e&&e.date&&!e.date.includes("Z")&&!e.date.includes("+")&&(e.date+="Z"),this.ticket=e,console.log("Ticket details loaded:",e),this.loading=!1},error:e=>{console.error("Error al cargar detalles del ticket:",e),this.loading=!1}})}calculateSubtotal(){return this.ticket?.lines?this.ticket.lines.reduce((e,m)=>e+m.subtotal,0):0}calculateTotal(){return this.ticket?.lines?this.ticket.lines.reduce((e,m)=>e+m.total,0):0}getPaymentMethodName(e){let m={CASH_MONEY:"Efectivo",cash_money:"Efectivo",cash:"Efectivo",CARD:"Tarjeta",card:"Tarjeta",TRANSFER:"Transferencia",transfer:"Transferencia",CASH_REFUND:"Devoluci\xF3n",cash_refund:"Devoluci\xF3n",paper:"Pago M\xF3vil",PAPER:"Pago M\xF3vil",PagoMovil:"Pago M\xF3vil",debt:"Cr\xE9dito",Credito:"Cr\xE9dito"};return m[e]||m[e?.toUpperCase()]||e}reprint(){this.ticket&&this.printService.printTicket(this.ticket)}close(){this.dialogRef.close()}static \u0275fac=function(m){return new(m||t)};static \u0275cmp=P({type:t,selectors:[["app-ticket-detail-dialog"]],decls:14,vars:3,consts:[["mat-dialog-title",""],[1,"dialog-content"],["diameter","40","class","spinner",4,"ngIf"],["class","ticket-details",4,"ngIf"],["align","end"],["mat-button","",3,"click"],["mat-raised-button","","color","accent",3,"click"],["diameter","40",1,"spinner"],[1,"ticket-details"],[1,"info-card"],[1,"info-grid"],[1,"info-item"],["class","info-item",4,"ngIf"],["class","info-item","style","grid-column: span 2;",4,"ngIf"],[1,"lines-card"],["mat-table","",1,"lines-table",3,"dataSource"],["matColumnDef","product"],["mat-header-cell","",4,"matHeaderCellDef"],["mat-cell","",4,"matCellDef"],["matColumnDef","units"],["matColumnDef","price"],["mat-header-cell","","style","text-align: right;",4,"matHeaderCellDef"],["mat-cell","","style","text-align: right;",4,"matCellDef"],["matColumnDef","tax"],["matColumnDef","total"],["mat-cell","","class","total-cell","style","text-align: right;",4,"matCellDef"],["mat-header-row","",4,"matHeaderRowDef"],["mat-row","",4,"matRowDef","matRowDefColumns"],[1,"summary-card"],[1,"summary-grid"],[1,"summary-row"],["class","summary-row",4,"ngFor","ngForOf"],["class","summary-row",4,"ngIf"],[1,"summary-row","total-row"],[1,"payments-section"],["class","payment-item",4,"ngFor","ngForOf"],[1,"info-item",2,"grid-column","span 2"],[1,"notes-box"],["mat-header-cell",""],["mat-cell",""],[1,"product-info"],["mat-header-cell","",2,"text-align","right"],["mat-cell","",2,"text-align","right"],["mat-cell","",1,"total-cell",2,"text-align","right"],["mat-header-row",""],["mat-row",""],[2,"text-align","right","display","flex","flex-direction","column","align-items","flex-end"],["style","color: #666;",4,"ngIf"],[2,"color","#666"],[1,"payment-item"],[1,"payment-main-info"],["class","payment-extra-details",4,"ngIf"],[1,"payment-extra-details"],[4,"ngIf"]],template:function(m,o){m&1&&(n(0,"h2",0)(1,"mat-icon"),a(2,"receipt"),i(),a(3),i(),n(4,"mat-dialog-content",1),s(5,dt,1,0,"mat-spinner",2)(6,Vt,82,26,"div",3),i(),n(7,"mat-dialog-actions",4)(8,"button",5),v("click",function(){return o.close()}),a(9,"CERRAR"),i(),n(10,"button",6),v("click",function(){return o.reprint()}),n(11,"mat-icon"),a(12,"print"),i(),a(13," REIMPRIMIR "),i()()),m&2&&(r(3),u(" Detalles del Ticket #",o.ticket==null?null:o.ticket.ticket_number," "),r(2),c("ngIf",o.loading),r(),c("ngIf",!o.loading&&o.ticket))},dependencies:[O,Pe,V,ee,ye,be,ke,F,B,L,H,X,$,z,Y,G,j,J,q,Z,K,Q,N,U,ge,pe,fe,_e,ue,oe,W],styles:[".dialog-content[_ngcontent-%COMP%]{min-width:500px;max-height:80vh;overflow-y:auto}.spinner[_ngcontent-%COMP%]{margin:40px auto;display:block}.ticket-details[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:20px}.info-card[_ngcontent-%COMP%], .lines-card[_ngcontent-%COMP%], .summary-card[_ngcontent-%COMP%]{margin:0}.info-grid[_ngcontent-%COMP%]{display:grid;grid-template-columns:repeat(2,1fr);gap:15px}.info-item[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:5px}.info-item[_ngcontent-%COMP%]   strong[_ngcontent-%COMP%]{color:#666;font-size:12px}.ticket-type[_ngcontent-%COMP%]{padding:4px 12px;border-radius:12px;font-size:12px;font-weight:500;display:inline-block}.type-0[_ngcontent-%COMP%]{background:#e3f2fd;color:#1976d2}.type-1[_ngcontent-%COMP%]{background:#ffebee;color:#c62828}.lines-table[_ngcontent-%COMP%]{width:100%;margin-top:10px}.product-info[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:2px}.product-info[_ngcontent-%COMP%]   small[_ngcontent-%COMP%]{color:#999;font-size:11px}.total-cell[_ngcontent-%COMP%]{font-weight:600;color:#2e7d32}.summary-grid[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:10px;padding:15px;background:#f9f9f9;border-radius:8px}.summary-row[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center}.total-row[_ngcontent-%COMP%]{border-top:2px solid #ddd;padding-top:10px;margin-top:5px;font-size:18px;color:#2e7d32}.payments-section[_ngcontent-%COMP%]{margin-top:20px}.payments-section[_ngcontent-%COMP%]   h4[_ngcontent-%COMP%]{margin-bottom:10px;color:#666}.payment-item[_ngcontent-%COMP%]{display:flex;flex-direction:column;padding:8px 15px;background:#f9f9f9;border-radius:4px;margin-bottom:5px}.payment-main-info[_ngcontent-%COMP%]{display:flex;justify-content:space-between;width:100%}.payment-extra-details[_ngcontent-%COMP%]{display:flex;flex-wrap:wrap;gap:10px;margin-top:4px;font-size:11px;color:#666;padding-top:4px;border-top:1px dashed #e0e0e0}h2[mat-dialog-title][_ngcontent-%COMP%]{display:flex;align-items:center;gap:10px}.notes-box[_ngcontent-%COMP%]{background:#fff9c4;padding:10px;border-radius:4px;border-left:4px solid #fbc02d;font-style:italic;margin-top:5px}"]})}return t})();function At(t,l){t&1&&D(0,"mat-spinner",7)}function Ht(t,l){if(t&1){let e=b();n(0,"th",30)(1,"mat-checkbox",31),v("change",function(o){x(e);let d=p(2);return h(d.toggleAll(o.checked))}),i()()}if(t&2){let e=p(2);r(),c("checked",e.allSelected())("indeterminate",e.someSelected())}}function Lt(t,l){if(t&1){let e=b();n(0,"td",32)(1,"mat-checkbox",33),w("ngModelChange",function(o){let d=x(e).$implicit;return T(d.selected,o)||(d.selected=o),h(o)}),v("change",function(){let o=x(e).$implicit,d=p(2);return h(d.onLineSelectionChange(o))}),i()()}if(t&2){let e=l.$implicit;r(),E("ngModel",e.selected)}}function Ut(t,l){t&1&&(n(0,"th",30),a(1,"Producto"),i())}function Nt(t,l){if(t&1&&(n(0,"td",32)(1,"div",34)(2,"strong"),a(3),i(),n(4,"small"),a(5),i()()()),t&2){let e=l.$implicit;r(3),f(e.product_name),r(2),f(e.product_reference)}}function Wt(t,l){t&1&&(n(0,"th",30),a(1,"Cant. Original"),i())}function $t(t,l){if(t&1&&(n(0,"td",32),a(1),i()),t&2){let e=l.$implicit;r(),f(e.units)}}function jt(t,l){t&1&&(n(0,"th",30),a(1,"Cant. a Devolver"),i())}function zt(t,l){if(t&1){let e=b();n(0,"td",32)(1,"mat-form-field",35)(2,"input",36),w("ngModelChange",function(o){let d=x(e).$implicit;return T(d.refundUnits,o)||(d.refundUnits=o),h(o)}),v("change",function(){let o=x(e).$implicit,d=p(2);return h(d.validateRefundUnits(o))}),i()()()}if(t&2){let e=l.$implicit;r(2),E("ngModel",e.refundUnits),c("disabled",!e.selected)("min",0)("max",e.units)}}function Gt(t,l){t&1&&(n(0,"th",30),a(1,"Precio Unit."),i())}function qt(t,l){if(t&1&&(n(0,"td",32),a(1),_(2,"currency"),i()),t&2){let e=l.$implicit;r(),f(R(2,1,e.price,"USD","symbol","1.2-2"))}}function Zt(t,l){t&1&&(n(0,"th",30),a(1,"Total Devoluci\xF3n"),i())}function Yt(t,l){if(t&1&&(n(0,"td",37),a(1),_(2,"currency"),i()),t&2){let e=l.$implicit,m=p(2);r(),u(" ",R(2,1,m.calculateLineRefund(e),"USD","symbol","1.2-2")," ")}}function Jt(t,l){t&1&&D(0,"tr",38)}function Kt(t,l){t&1&&D(0,"tr",39)}function Qt(t,l){if(t&1){let e=b();n(0,"div",8)(1,"div",9)(2,"p")(3,"strong"),a(4,"Cliente:"),i(),a(5),i(),n(6,"p")(7,"strong"),a(8,"Fecha Original:"),i(),a(9),_(10,"systemDate"),i()(),n(11,"h3"),a(12,"Seleccione los productos a devolver:"),i(),n(13,"table",10),g(14,11),s(15,Ht,2,2,"th",12)(16,Lt,2,1,"td",13),C(),g(17,14),s(18,Ut,2,0,"th",12)(19,Nt,6,2,"td",13),C(),g(20,15),s(21,Wt,2,0,"th",12)(22,$t,2,1,"td",13),C(),g(23,16),s(24,jt,2,0,"th",12)(25,zt,3,4,"td",13),C(),g(26,17),s(27,Gt,2,0,"th",12)(28,qt,3,6,"td",13),C(),g(29,18),s(30,Zt,2,0,"th",12)(31,Yt,3,6,"td",19),C(),s(32,Jt,1,0,"tr",20)(33,Kt,1,0,"tr",21),i(),n(34,"div",22)(35,"div",23)(36,"span"),a(37,"Subtotal Devoluci\xF3n:"),i(),n(38,"strong"),a(39),_(40,"currency"),i()(),n(41,"div",23)(42,"span"),a(43,"IVA:"),i(),n(44,"strong"),a(45),_(46,"currency"),i()(),n(47,"div",24)(48,"span"),a(49,"TOTAL A DEVOLVER:"),i(),n(50,"strong"),a(51),_(52,"currency"),i()()(),n(53,"mat-form-field",25)(54,"mat-label"),a(55,"M\xE9todo de Devoluci\xF3n"),i(),n(56,"mat-select",26),w("ngModelChange",function(o){x(e);let d=p();return T(d.refundPaymentMethod,o)||(d.refundPaymentMethod=o),h(o)}),n(57,"mat-option",27),a(58,"Efectivo"),i(),n(59,"mat-option",28),a(60,"Tarjeta"),i(),n(61,"mat-option",29),a(62,"Pago M\xF3vil"),i()()()()}if(t&2){let e=p();r(5),u(" ",e.ticket.customer_name||"P\xFAblico General"),r(4),u(" ",I(10,9,e.ticket.date)),r(4),c("dataSource",e.refundLines),r(19),c("matHeaderRowDef",e.displayedColumns),r(),c("matRowDefColumns",e.displayedColumns),r(6),f(R(40,11,e.calculateRefundSubtotal(),"USD","symbol","1.2-2")),r(6),f(R(46,16,e.calculateRefundTax(),"USD","symbol","1.2-2")),r(6),f(R(52,21,e.calculateRefundTotal(),"USD","symbol","1.2-2")),r(5),E("ngModel",e.refundPaymentMethod)}}var rt=(()=>{class t{salesHistoryService=S(te);dialogRef=S(ve);snackBar=S(A);data=S(De);ticket=null;refundLines=[];loading=!0;processing=!1;refundPaymentMethod="CASH_REFUND";displayedColumns=["select","product","original_units","refund_units","price","refund_total"];ngOnInit(){this.loadTicketDetails()}loadTicketDetails(){this.salesHistoryService.getTicketById(this.data.ticketId).subscribe({next:e=>{this.ticket=e,this.refundLines=(e.lines||[]).map(m=>ne(ie({},m),{selected:!1,refundUnits:m.units})),this.loading=!1},error:e=>{console.error("Error al cargar detalles del ticket:",e),this.snackBar.open("Error al cargar ticket","Cerrar",{duration:3e3}),this.loading=!1}})}toggleAll(e){this.refundLines.forEach(m=>{m.selected=e,e||(m.refundUnits=m.units)})}allSelected(){return this.refundLines.length>0&&this.refundLines.every(e=>e.selected)}someSelected(){return this.refundLines.some(e=>e.selected)&&!this.allSelected()}onLineSelectionChange(e){e.selected||(e.refundUnits=e.units)}validateRefundUnits(e){e.refundUnits<0&&(e.refundUnits=0),e.refundUnits>e.units&&(e.refundUnits=e.units)}calculateLineRefund(e){return e.selected?e.refundUnits*e.price*(1+e.tax_rate):0}calculateRefundSubtotal(){return this.refundLines.filter(e=>e.selected).reduce((e,m)=>e+m.refundUnits*m.price,0)}calculateRefundTax(){return this.refundLines.filter(e=>e.selected).reduce((e,m)=>e+m.refundUnits*m.price*m.tax_rate,0)}calculateRefundTotal(){return this.calculateRefundSubtotal()+this.calculateRefundTax()}canProcessRefund(){return this.refundLines.some(m=>m.selected&&m.refundUnits>0)&&!!this.refundPaymentMethod}processRefund(){if(!this.canProcessRefund()||!this.ticket)return;let e=this.refundLines.filter(o=>o.selected&&o.refundUnits>0),m={person_id:this.ticket.cashier_id,refund_lines:e.map(o=>({product_id:o.product,units:o.refundUnits,price:o.price,taxid:o.taxid,tax_rate:o.tax_rate})),refund_payment_method:this.refundPaymentMethod,cash_register_id:void 0,currency_id:this.ticket.currency_id,exchange_rate:this.ticket.exchange_rate};this.processing=!0,this.salesHistoryService.processRefund(this.ticket.id,m).subscribe({next:o=>{this.snackBar.open(`Devoluci\xF3n procesada exitosamente. Ticket #${o.refundTicketNumber}`,"Cerrar",{duration:5e3}),this.dialogRef.close(o)},error:o=>{console.error("Error al procesar devoluci\xF3n:",o),this.snackBar.open("Error al procesar devoluci\xF3n: "+(o.error?.error||"Error desconocido"),"Cerrar",{duration:5e3}),this.processing=!1}})}close(){this.dialogRef.close()}static \u0275fac=function(m){return new(m||t)};static \u0275cmp=P({type:t,selectors:[["app-refund-dialog"]],decls:14,vars:6,consts:[["mat-dialog-title",""],[1,"dialog-content"],["diameter","40","class","spinner",4,"ngIf"],["class","refund-content",4,"ngIf"],["align","end"],["mat-button","",3,"click","disabled"],["mat-raised-button","","color","warn",3,"click","disabled"],["diameter","40",1,"spinner"],[1,"refund-content"],[1,"info-section"],["mat-table","",1,"refund-table",3,"dataSource"],["matColumnDef","select"],["mat-header-cell","",4,"matHeaderCellDef"],["mat-cell","",4,"matCellDef"],["matColumnDef","product"],["matColumnDef","original_units"],["matColumnDef","refund_units"],["matColumnDef","price"],["matColumnDef","refund_total"],["mat-cell","","class","total-cell",4,"matCellDef"],["mat-header-row","",4,"matHeaderRowDef"],["mat-row","",4,"matRowDef","matRowDefColumns"],[1,"refund-summary"],[1,"summary-row"],[1,"summary-row","total-row"],["appearance","outline",1,"full-width"],[3,"ngModelChange","ngModel"],["value","CASH_REFUND"],["value","CARD"],["value","TRANSFER"],["mat-header-cell",""],[3,"change","checked","indeterminate"],["mat-cell",""],[3,"ngModelChange","change","ngModel"],[1,"product-info"],["appearance","outline",1,"units-field"],["matInput","","type","number",3,"ngModelChange","change","ngModel","disabled","min","max"],["mat-cell","",1,"total-cell"],["mat-header-row",""],["mat-row",""]],template:function(m,o){m&1&&(n(0,"h2",0)(1,"mat-icon"),a(2,"assignment_return"),i(),a(3),i(),n(4,"mat-dialog-content",1),s(5,At,1,0,"mat-spinner",2)(6,Qt,63,26,"div",3),i(),n(7,"mat-dialog-actions",4)(8,"button",5),v("click",function(){return o.close()}),a(9,"CANCELAR"),i(),n(10,"button",6),v("click",function(){return o.processRefund()}),n(11,"mat-icon"),a(12,"assignment_return"),i(),a(13),i()()),m&2&&(r(3),u(" Procesar Devoluci\xF3n - Ticket #",o.ticket==null?null:o.ticket.ticket_number," "),r(2),c("ngIf",o.loading),r(),c("ngIf",!o.loading&&o.ticket),r(2),c("disabled",o.processing),r(2),c("disabled",!o.canProcessRefund()||o.processing),r(3),u(" ",o.processing?"PROCESANDO...":"PROCESAR DEVOLUCI\xD3N"," "))},dependencies:[O,V,se,le,de,me,Fe,Be,ce,ee,ye,be,ke,F,B,L,H,X,$,z,Y,G,j,J,q,Z,K,Q,Je,Ye,he,xe,Ce,Se,Me,Ue,Le,Re,N,U,re,Ie,W],styles:[".dialog-content[_ngcontent-%COMP%]{min-width:800px;max-height:70vh;overflow-y:auto}.spinner[_ngcontent-%COMP%]{margin:40px auto;display:block}.refund-content[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:20px}.info-section[_ngcontent-%COMP%]{background:#f5f5f5;padding:15px;border-radius:8px}.info-section[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{margin:5px 0}h3[_ngcontent-%COMP%]{margin:20px 0 10px;color:#333}.refund-table[_ngcontent-%COMP%]{width:100%}.product-info[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:2px}.product-info[_ngcontent-%COMP%]   small[_ngcontent-%COMP%]{color:#999;font-size:11px}.units-field[_ngcontent-%COMP%]{width:80px;margin-bottom:-1.25em}.total-cell[_ngcontent-%COMP%]{font-weight:600;color:#c62828}.refund-summary[_ngcontent-%COMP%]{background:#fff3e0;padding:20px;border-radius:8px;display:flex;flex-direction:column;gap:10px}.summary-row[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center}.total-row[_ngcontent-%COMP%]{border-top:2px solid #ff9800;padding-top:10px;margin-top:5px;font-size:18px;color:#c62828}.full-width[_ngcontent-%COMP%]{width:100%}h2[mat-dialog-title][_ngcontent-%COMP%]{display:flex;align-items:center;gap:10px;color:#c62828}"]})}return t})();function Xt(t,l){t&1&&D(0,"mat-spinner",21)}function ei(t,l){t&1&&(n(0,"div",22)(1,"mat-icon"),a(2,"receipt_long"),i(),n(3,"p"),a(4,"No se encontraron ventas con los filtros seleccionados"),i()())}function ti(t,l){t&1&&(n(0,"th",36),a(1,"Fecha"),i())}function ii(t,l){if(t&1&&(n(0,"td",37),a(1),_(2,"systemDate"),i()),t&2){let e=l.$implicit;r(),f(I(2,1,e.date))}}function ni(t,l){t&1&&(n(0,"th",36),a(1,"Ticket #"),i())}function ai(t,l){if(t&1&&(n(0,"td",37),a(1),i()),t&2){let e=l.$implicit;r(),f(e.ticket_number)}}function oi(t,l){t&1&&(n(0,"th",36),a(1,"Tipo"),i())}function ri(t,l){if(t&1&&(n(0,"td",37)(1,"span"),a(2),i()()),t&2){let e=l.$implicit;r(),ae("ticket-type type-"+e.tickettype),r(),u(" ",e.tickettype===0?"Venta":e.tickettype===1?"Devoluci\xF3n":"Abono"," ")}}function li(t,l){t&1&&(n(0,"th",36),a(1,"Cliente"),i())}function mi(t,l){if(t&1&&(n(0,"td",37),a(1),i()),t&2){let e=l.$implicit;r(),f(e.customer_name||"P\xFAblico General")}}function ci(t,l){t&1&&(n(0,"th",36),a(1,"Cajero"),i())}function di(t,l){if(t&1&&(n(0,"td",37),a(1),i()),t&2){let e=l.$implicit;r(),f(e.cashier_name)}}function si(t,l){t&1&&(n(0,"th",36),a(1,"Total"),i())}function pi(t,l){if(t&1&&(n(0,"td",38),a(1),_(2,"number"),i()),t&2){let e=l.$implicit;r(),u(" Bs. ",y(2,1,e.total*(e.exchange_rate||1),"1.2-2")," ")}}function ui(t,l){t&1&&(n(0,"th",36),a(1,"Acciones"),i())}function fi(t,l){if(t&1){let e=b();n(0,"button",42),v("click",function(){x(e);let o=p().$implicit,d=p(2);return h(d.processRefund(o))}),n(1,"mat-icon"),a(2,"assignment_return"),i()()}}function _i(t,l){if(t&1){let e=b();n(0,"td",37)(1,"button",39),v("click",function(){let o=x(e).$implicit,d=p(2);return h(d.viewTicketDetails(o))}),n(2,"mat-icon"),a(3,"visibility"),i()(),n(4,"button",40),v("click",function(){let o=x(e).$implicit,d=p(2);return h(d.reprintTicket(o))}),n(5,"mat-icon"),a(6,"print"),i()(),s(7,fi,3,0,"button",41),i()}if(t&2){let e=l.$implicit;r(7),c("ngIf",e.tickettype===0)}}function gi(t,l){t&1&&D(0,"tr",43)}function Ci(t,l){t&1&&D(0,"tr",44)}function xi(t,l){if(t&1&&(n(0,"table",23),g(1,24),s(2,ti,2,0,"th",25)(3,ii,3,3,"td",26),C(),g(4,27),s(5,ni,2,0,"th",25)(6,ai,2,1,"td",26),C(),g(7,28),s(8,oi,2,0,"th",25)(9,ri,3,3,"td",26),C(),g(10,29),s(11,li,2,0,"th",25)(12,mi,2,1,"td",26),C(),g(13,30),s(14,ci,2,0,"th",25)(15,di,2,1,"td",26),C(),g(16,31),s(17,si,2,0,"th",25)(18,pi,3,4,"td",32),C(),g(19,33),s(20,ui,2,0,"th",25)(21,_i,8,1,"td",26),C(),s(22,gi,1,0,"tr",34)(23,Ci,1,0,"tr",35),i()),t&2){let e=p();c("dataSource",e.tickets),r(22),c("matHeaderRowDef",e.displayedColumns),r(),c("matRowDefColumns",e.displayedColumns)}}function hi(t,l){if(t&1){let e=b();n(0,"app-shared-paginator",45),v("page",function(o){x(e);let d=p();return h(d.onPageChange(o))}),i()}if(t&2){let e=p();c("length",e.pagination.total)("pageSize",e.pagination.limit)("pageIndex",e.pagination.page-1)}}var En=(()=>{class t{salesHistoryService=S(te);dialog=S(Ze);snackBar=S(A);printService=S(Ee);tickets=[];loading=!1;selectedCustomer=null;filters={page:1,limit:50};pagination={page:1,limit:50,total:0,totalPages:0};displayedColumns=["date","ticket_number","type","customer","cashier","total","actions"];ngOnInit(){this.loadDefaultData()}loadDefaultData(){let e=new Date;e.setHours(0,0,0,0),this.filters.startDate=e.toISOString(),this.search()}async openCustomerSelector(){this.dialog.open(Qe,{width:"500px"}).afterClosed().subscribe(m=>{m&&(this.selectedCustomer=m,this.filters.customerId=m.id)})}search(){this.loading=!0,this.filters.page=1;let e=ie({},this.filters);e.startDate&&typeof e.startDate=="object"&&(e.startDate=e.startDate.toISOString()),e.endDate&&typeof e.endDate=="object"&&(e.endDate=e.endDate.toISOString()),this.salesHistoryService.getSalesHistory(e).subscribe({next:m=>{this.tickets=m.tickets.map(o=>ne(ie({},o),{date:o.date&&!o.date.includes("Z")&&!o.date.includes("+")?o.date+"Z":o.date})),this.pagination=m.pagination,this.loading=!1},error:m=>{console.error("Error al buscar ventas:",m),this.snackBar.open("Error al buscar ventas","Cerrar",{duration:3e3}),this.loading=!1}})}clearFilters(){this.filters={page:1,limit:50},this.selectedCustomer=null,this.tickets=[],this.pagination={page:1,limit:50,total:0,totalPages:0}}onPageChange(e){this.filters.page=e.pageIndex+1,this.filters.limit=e.pageSize,this.search()}viewTicketDetails(e){this.dialog.open(ot,{width:"800px",maxWidth:"95vw",data:{ticketId:e.id}})}reprintTicket(e){this.snackBar.open(`Cargando ticket #${e.ticket_number} para imprimir...`,"Cerrar",{duration:2e3}),this.salesHistoryService.getTicketById(e.id).subscribe({next:m=>{this.printService.printTicket(m)},error:m=>{console.error("Error al cargar ticket para imprimir:",m),this.snackBar.open("Error al cargar ticket","Cerrar",{duration:3e3})}})}processRefund(e){this.dialog.open(rt,{width:"900px",data:{ticketId:e.id}}).afterClosed().subscribe(o=>{o&&(this.snackBar.open("Devoluci\xF3n procesada exitosamente","Cerrar",{duration:3e3}),this.search())})}static \u0275fac=function(m){return new(m||t)};static \u0275cmp=P({type:t,selectors:[["app-consultar-ventas"]],decls:58,vars:16,consts:[["startPicker",""],["endPicker",""],[1,"container"],[1,"main-card"],[1,"filters-panel"],[1,"filter-row"],["appearance","outline"],["matInput","",3,"ngModelChange","matDatepicker","ngModel"],["matSuffix","",3,"for"],["matInput","","type","number","placeholder","Ej: 1234",3,"ngModelChange","ngModel"],["matSuffix",""],["mat-raised-button","",1,"customer-btn",3,"click"],["matInput","","type","text","placeholder","0.00","appMoneyInput","","decimalType","total",3,"ngModelChange","ngModel"],["matPrefix",""],["mat-raised-button","","color","primary",3,"click","disabled"],["mat-stroked-button","",3,"click","disabled"],[1,"results-section"],["diameter","50","class","spinner",4,"ngIf"],["class","no-results",4,"ngIf"],["mat-table","","class","tickets-table",3,"dataSource",4,"ngIf"],[3,"length","pageSize","pageIndex","page",4,"ngIf"],["diameter","50",1,"spinner"],[1,"no-results"],["mat-table","",1,"tickets-table",3,"dataSource"],["matColumnDef","date"],["mat-header-cell","",4,"matHeaderCellDef"],["mat-cell","",4,"matCellDef"],["matColumnDef","ticket_number"],["matColumnDef","type"],["matColumnDef","customer"],["matColumnDef","cashier"],["matColumnDef","total"],["mat-cell","","class","total-cell",4,"matCellDef"],["matColumnDef","actions"],["mat-header-row","",4,"matHeaderRowDef"],["mat-row","",4,"matRowDef","matRowDefColumns"],["mat-header-cell",""],["mat-cell",""],["mat-cell","",1,"total-cell"],["mat-icon-button","","color","primary","matTooltip","Ver detalles",3,"click"],["mat-icon-button","","color","accent","matTooltip","Reimprimir",3,"click"],["mat-icon-button","","color","warn","matTooltip","Procesar devoluci\xF3n",3,"click",4,"ngIf"],["mat-icon-button","","color","warn","matTooltip","Procesar devoluci\xF3n",3,"click"],["mat-header-row",""],["mat-row",""],[3,"page","length","pageSize","pageIndex"]],template:function(m,o){if(m&1){let d=b();n(0,"div",2)(1,"mat-card",3)(2,"mat-card-header")(3,"mat-card-title"),a(4,"Historial de Ventas"),i()(),n(5,"mat-card-content")(6,"div",4)(7,"div",5)(8,"mat-form-field",6)(9,"mat-label"),a(10,"Fecha Inicio"),i(),n(11,"input",7),w("ngModelChange",function(M){return x(d),T(o.filters.startDate,M)||(o.filters.startDate=M),h(M)}),i(),D(12,"mat-datepicker-toggle",8)(13,"mat-datepicker",null,0),i(),n(15,"mat-form-field",6)(16,"mat-label"),a(17,"Fecha Fin"),i(),n(18,"input",7),w("ngModelChange",function(M){return x(d),T(o.filters.endDate,M)||(o.filters.endDate=M),h(M)}),i(),D(19,"mat-datepicker-toggle",8)(20,"mat-datepicker",null,1),i(),n(22,"mat-form-field",6)(23,"mat-label"),a(24,"N\xFAmero de Ticket"),i(),n(25,"input",9),w("ngModelChange",function(M){return x(d),T(o.filters.ticketNumber,M)||(o.filters.ticketNumber=M),h(M)}),i(),n(26,"mat-icon",10),a(27,"receipt"),i()(),n(28,"button",11),v("click",function(){return x(d),h(o.openCustomerSelector())}),n(29,"mat-icon"),a(30,"person"),i(),a(31),i()(),n(32,"div",5)(33,"mat-form-field",6)(34,"mat-label"),a(35,"Total M\xEDnimo (Bs.)"),i(),n(36,"input",12),w("ngModelChange",function(M){return x(d),T(o.filters.minTotal,M)||(o.filters.minTotal=M),h(M)}),i(),n(37,"span",13),a(38,"Bs.\xA0"),i()(),n(39,"mat-form-field",6)(40,"mat-label"),a(41,"Total M\xE1ximo (Bs.)"),i(),n(42,"input",12),w("ngModelChange",function(M){return x(d),T(o.filters.maxTotal,M)||(o.filters.maxTotal=M),h(M)}),i(),n(43,"span",13),a(44,"Bs.\xA0"),i()(),n(45,"button",14),v("click",function(){return x(d),h(o.search())}),n(46,"mat-icon"),a(47,"search"),i(),a(48," BUSCAR "),i(),n(49,"button",15),v("click",function(){return x(d),h(o.clearFilters())}),n(50,"mat-icon"),a(51,"clear"),i(),a(52," LIMPIAR "),i()()(),n(53,"div",16),s(54,Xt,1,0,"mat-spinner",17)(55,ei,5,0,"div",18)(56,xi,24,3,"table",19)(57,hi,1,3,"app-shared-paginator",20),i()()()()}if(m&2){let d=Te(14),k=Te(21);r(11),c("matDatepicker",d),E("ngModel",o.filters.startDate),r(),c("for",d),r(6),c("matDatepicker",k),E("ngModel",o.filters.endDate),r(),c("for",k),r(6),E("ngModel",o.filters.ticketNumber),r(6),u(" ",o.selectedCustomer?o.selectedCustomer.name:"Seleccionar Cliente"," "),r(5),E("ngModel",o.filters.minTotal),r(6),E("ngModel",o.filters.maxTotal),r(3),c("disabled",o.loading),r(4),c("disabled",o.loading),r(5),c("ngIf",o.loading),r(),c("ngIf",!o.loading&&o.tickets.length===0),r(),c("ngIf",!o.loading&&o.tickets.length>0),r(),c("ngIf",!o.loading&&o.tickets.length>0)}},dependencies:[O,V,se,le,de,me,ce,ge,pe,fe,_e,ue,F,B,Oe,L,H,X,$,z,Y,G,j,J,q,Z,K,Q,he,xe,Ce,Ae,He,Se,Me,qe,je,ze,Ge,Ve,N,U,Ne,We,ee,re,Ke,oe,W],styles:[".container[_ngcontent-%COMP%], .main-card[_ngcontent-%COMP%]{padding:20px}.filters-panel[_ngcontent-%COMP%]{background:#f5f5f5;padding:20px;border-radius:8px;margin-bottom:20px}.filter-row[_ngcontent-%COMP%]{display:flex;gap:15px;align-items:center;margin-bottom:10px}.filter-row[_ngcontent-%COMP%]:last-child{margin-bottom:0}.filter-row[_ngcontent-%COMP%]   mat-form-field[_ngcontent-%COMP%]{flex:1}.customer-btn[_ngcontent-%COMP%]{height:56px;min-width:200px}.results-section[_ngcontent-%COMP%]{position:relative;min-height:300px}.spinner[_ngcontent-%COMP%]{margin:50px auto;display:block}.no-results[_ngcontent-%COMP%]{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:60px 20px;color:#999}.no-results[_ngcontent-%COMP%]   mat-icon[_ngcontent-%COMP%]{font-size:64px;width:64px;height:64px;margin-bottom:20px}.tickets-table[_ngcontent-%COMP%]{width:100%;margin-bottom:20px}.total-cell[_ngcontent-%COMP%]{font-weight:600;color:#2e7d32}.ticket-type[_ngcontent-%COMP%]{padding:4px 12px;border-radius:12px;font-size:12px;font-weight:500}.type-0[_ngcontent-%COMP%]{background:#e3f2fd;color:#1976d2}.type-1[_ngcontent-%COMP%]{background:#ffebee;color:#c62828}.type-2[_ngcontent-%COMP%]{background:#f3e5f5;color:#7b1fa2}mat-card-header[_ngcontent-%COMP%]{margin-bottom:20px}"]})}return t})();export{En as ConsultarVentasComponent};
