import{a as rt,b as ce,c as lt}from"./chunk-LM6RXHSR.js";import"./chunk-ISB5W5SX.js";import{a as te}from"./chunk-R3L57XND.js";import{a as ne}from"./chunk-NL74O3Y5.js";import{a as Z}from"./chunk-6XGWOI35.js";import"./chunk-DEAF3FKS.js";import"./chunk-34EVCEMG.js";import{a as ee}from"./chunk-BK63NQ7D.js";import"./chunk-7UZYWCAJ.js";import"./chunk-7KQW3R3P.js";import{c as ye,d as Me,f as me,g as de,h as Se}from"./chunk-CJPLD6EO.js";import{a as Ye,b as Je,c as Ke}from"./chunk-HIZ742YJ.js";import"./chunk-XEWEKXFC.js";import{a as at}from"./chunk-NN3ONOAJ.js";import{a as ot}from"./chunk-RFRKPPY3.js";import{a as Xe,b as Ze,c as et,e as tt,f as nt,g as it,h as X}from"./chunk-Z6YHTX75.js";import{a as W,b as U}from"./chunk-26KDQVR5.js";import{a as K}from"./chunk-DGQM6DPS.js";import{a as Re}from"./chunk-SCPRHZYR.js";import"./chunk-N7P7XLP2.js";import"./chunk-N5ZCCEPE.js";import"./chunk-GRESZPIF.js";import"./chunk-EQXJNMRX.js";import{b as G,c as Q}from"./chunk-APXOZHQA.js";import{a as Ae,b as Ve,c as We,d as Ue,e as ze,f as Le,g as He,h as Ne,i as $e,j as je,l as qe}from"./chunk-VJGP4MMT.js";import{a as Ge,b as Qe}from"./chunk-VNZMNOUU.js";import"./chunk-YCMZOG5D.js";import{a as Ee,b as De,c as ke,f as Ie,h as Te}from"./chunk-ZWM7H6SC.js";import{a as Oe}from"./chunk-PALJ6VDH.js";import"./chunk-TEMJ73U5.js";import{d as Pe}from"./chunk-52A733DE.js";import"./chunk-GPHRSLLH.js";import{b as $,e as Fe,f as Be,i as j,j as q}from"./chunk-EWTXOCXT.js";import{b as z,f as L,j as H,x as N}from"./chunk-AVLO2MYP.js";import{a as Y,b as J}from"./chunk-JI7GBIO6.js";import"./chunk-VTP6RNFS.js";import{H as we,I as A,K as V}from"./chunk-M7DMR53X.js";import"./chunk-JAVK727W.js";import"./chunk-3TNWXQYU.js";import"./chunk-UWUK32S4.js";import{k as B,l as O,r as le,s as D,v as R}from"./chunk-ZD4QWOHN.js";import{$ as _,$b as _e,Fb as s,Gb as i,Hb as a,Ib as oe,Lc as F,Mb as S,Nb as P,Pb as E,Ub as u,Wa as l,Wb as p,_b as Ce,ac as fe,db as I,ea as x,fa as v,gc as w,ic as r,jb as T,jc as k,kc as C,lc as re,mc as he,nc as b,oc as y,pb as g,pc as M,rc as xe,sc as ve,vc as f,wc as be,xc as h,zb as ue}from"./chunk-WSMHJDAT.js";import{a as pe,b as ge}from"./chunk-C6Q5SG76.js";function ht(n,d){if(n&1&&(i(0,"div",3)(1,"label"),r(2,"Equivalente en Bs."),a(),i(3,"span",32),r(4),f(5,"number"),a()()),n&2){let e=p();l(4),C("",h(5,1,e.data.customer.curdebt*e.data.exchangeRate,e.totalFormat)," Bs.")}}function xt(n,d){if(n&1&&(i(0,"mat-option",33),r(1),f(2,"number"),a()),n&2){let e=d.$implicit,o=p();s("value",e),l(),re(" ",e.dateInvoices," - Saldo: $ ",h(2,3,e.balance,o.totalFormat)," ")}}function vt(n,d){if(n&1){let e=E();i(0,"mat-form-field",7)(1,"mat-label"),r(2,"Monto a Pagar (Bs)"),a(),i(3,"span",34),r(4,"Bs. \xA0"),a(),i(5,"input",35),M("ngModelChange",function(t){x(e);let m=p();return y(m.amountBs,t)||(m.amountBs=t),v(t)}),u("ngModelChange",function(t){x(e);let m=p();return v(m.onAmountBsChange(t))}),a()()}if(n&2){let e=p();l(5),b("ngModel",e.amountBs)}}function bt(n,d){if(n&1){let e=E();i(0,"mat-form-field",7)(1,"mat-label"),r(2,"Monto a Pagar (USD)"),a(),i(3,"span",34),r(4,"$ \xA0"),a(),i(5,"input",35),M("ngModelChange",function(t){x(e);let m=p();return y(m.amountUsd,t)||(m.amountUsd=t),v(t)}),u("ngModelChange",function(t){x(e);let m=p();return v(m.onAmountUsdChange(t))}),a()()}if(n&2){let e=p();l(5),b("ngModel",e.amountUsd)}}function yt(n,d){if(n&1&&(i(0,"span",39),r(1,"Equivale a: "),i(2,"strong"),r(3),f(4,"number"),a()()),n&2){let e=p(2);l(3),C("$ ",h(4,1,e.amountUsd,e.totalFormat))}}function Mt(n,d){if(n&1&&(i(0,"span",39),r(1,"Equivale a: "),i(2,"strong"),r(3),f(4,"number"),a()()),n&2){let e=p(2);l(3),C("",h(4,1,e.amountBs,e.totalFormat)," Bs.")}}function St(n,d){if(n&1&&(i(0,"div",36)(1,"span",37),r(2,"Tasa: "),i(3,"strong"),r(4),f(5,"number"),a()(),g(6,yt,5,4,"span",38)(7,Mt,5,4,"span",38),a()),n&2){let e=p();l(4),k(h(5,3,e.data.exchangeRate,"1.2-2")),l(2),s("ngIf",e.selectedCurrency==="base"),l(),s("ngIf",e.selectedCurrency==="alt")}}function Pt(n,d){if(n&1&&(i(0,"div",40)(1,"span",41),r(2),i(3,"strong"),r(4),f(5,"number"),a(),r(6," / "),i(7,"strong"),r(8),f(9,"number"),a()()()),n&2){let e,o=p();l(2),C("IGTF (",(e=o.settingsService.getSettings())==null?null:e.igtf_percentage,"%): "),l(2),C("$ ",h(5,3,o.igtfAmountAlt,o.totalFormat)),l(4),C("",h(9,6,o.igtfAmount,o.totalFormat)," Bs.")}}function wt(n,d){if(n&1&&(i(0,"div",44),r(1),f(2,"number"),a()),n&2){let e=p(2);l(),re(" Vuelto: ",h(2,2,e.change,e.totalFormat)," ",e.selectedCurrency==="base"?"Bs.":"USD"," ")}}function Et(n,d){if(n&1){let e=E();i(0,"div",42)(1,"mat-form-field",7)(2,"mat-label"),r(3),a(),i(4,"input",35),M("ngModelChange",function(t){x(e);let m=p();return y(m.amountReceived,t)||(m.amountReceived=t),v(t)}),u("ngModelChange",function(t){x(e);let m=p();return v(m.onAmountReceivedChange(t))}),a()(),g(5,wt,3,5,"div",43),a()}if(n&2){let e=p();l(3),C("Monto Recibido (",e.selectedCurrency==="base"?"Bs.":"USD",")"),l(),b("ngModel",e.amountReceived),l(),s("ngIf",e.change>0)}}function Dt(n,d){if(n&1&&(i(0,"mat-option",33),r(1),a()),n&2){let e=d.$implicit;s("value",e.id),l(),he(" ",e.name," - ",e.account_type_name," (",e.currency,") ")}}var mt=(()=>{class n{dialogRef;cdr;data;customerService=_(te);settingsService=_(K);snackBar=_(W);salesService=_(Z);cashService=_(ee);banksService=_(at);isLoading=!1;invoices=[];selectedInvoice=null;amountBs=0;amountUsd=0;amountReceived=0;change=0;paymentMethod="cash";numDocument="";bank="";selectedBankId="";banks=[];cedula="";reference="";account="";is_pago_movil=!1;selectedCurrency="base";igtfAmount=0;igtfAmountAlt=0;totalFormat="1.2-2";constructor(e,o,t){this.dialogRef=e,this.cdr=o,this.data=t}ngOnInit(){this.totalFormat=this.settingsService.getDecimalFormat("total"),this.loadInvoices(),this.loadBanks()}loadBanks(){this.banksService.getBanks(!0).subscribe(e=>{this.banks=e,this.cdr.markForCheck()})}loadInvoices(){this.customerService.getInvoices(this.data.customer.id).subscribe(e=>{this.invoices=e,this.cdr.markForCheck()})}onInvoiceChange(e){this.amountUsd=e.balance,this.onAmountUsdChange(this.amountUsd),this.cdr.markForCheck()}onAmountBsChange(e){let o=this.data.exchangeRate||1,t=this.settingsService.getSettings()?.total_decimals||2;this.amountUsd=parseFloat((e/o).toFixed(t)),this.calculateIGTF(),this.cdr.markForCheck()}onAmountUsdChange(e){let o=this.data.exchangeRate||1,t=this.settingsService.getSettings()?.total_decimals||2;this.amountBs=parseFloat((e*o).toFixed(t)),this.calculateIGTF(),this.cdr.markForCheck()}calculateIGTF(){let e=this.settingsService.getSettings(),o=this.data.exchangeRate||1,t=e?.total_decimals||2;if(this.selectedCurrency==="alt"){let m=e?.igtf_enabled?(e.igtf_percentage||3)/100:0;this.igtfAmountAlt=parseFloat((this.amountUsd*m).toFixed(t)),this.igtfAmount=parseFloat((this.igtfAmountAlt*o).toFixed(t))}else this.igtfAmountAlt=0,this.igtfAmount=0}onAmountReceivedChange(e){let o=this.selectedCurrency==="base"?this.amountBs:this.amountUsd;this.selectedCurrency==="alt"?o+=this.igtfAmountAlt:o+=this.igtfAmount,this.change=Math.max(0,parseFloat((e-o).toFixed(2))),this.cdr.markForCheck()}setCurrency(e){this.selectedCurrency=e,this.calculateIGTF(),this.amountReceived=0,this.change=0,this.cdr.markForCheck()}setPaymentMethod(e){this.paymentMethod=e,this.is_pago_movil=e==="paper"||e==="PagoMovil",this.cdr.markForCheck()}getFilteredBanks(){return this.paymentMethod==="paper"||this.paymentMethod==="PagoMovil"?this.banks.filter(e=>e.allows_pago_movil):this.banks}isValid(){return this.amountUsd>0&&!!this.selectedInvoice}onCancel(){this.dialogRef.close()}onConfirm(){let e={customer_id:this.data.customer.id,igtf_amount:this.igtfAmount,igtf_amount_alt:this.igtfAmountAlt,change:this.change,payments:[{method:this.paymentMethod==="paper"?"PagoMovil":this.paymentMethod==="transfer"?"transfer":this.paymentMethod,total:this.selectedCurrency==="alt"?this.amountUsd:this.amountBs,currency_id:this.selectedCurrency==="alt"?2:1,bank:this.banks.find(m=>m.id===this.selectedBankId)?.name||this.bank,bank_id:this.selectedBankId,cedula:this.cedula,reference:this.reference,account_number:this.account,is_pago_movil:this.is_pago_movil,invoice_number:this.selectedInvoice.numberInvoice,amount_base:this.amountBs}],exchange_rate:this.data.exchangeRate,currency_id:this.selectedCurrency==="alt"?2:1},o=JSON.parse(localStorage.getItem("user")||"{}"),t=ge(pe({},e),{person_id:o.id||1,cash_register_id:this.cashService.getCashRegisterId(),money_id:this.cashService.getMoneyId()||"CASH_MONEY"});this.isLoading=!0,this.cdr.markForCheck(),this.salesService.createDebtPayment(t).subscribe({next:()=>{this.isLoading=!1,this.dialogRef.close(!0)},error:m=>{console.error(m),this.isLoading=!1,this.snackBar.open("Error al procesar el pago","Cerrar",{duration:5e3}),this.cdr.markForCheck()}})}static \u0275fac=function(o){return new(o||n)(I(Xe),I(F),I(Ze))};static \u0275cmp=T({type:n,selectors:[["app-cx-c-payment-dialog"]],decls:77,vars:36,consts:[[1,"payment-container"],["mat-dialog-title",""],[1,"totals-summary"],[1,"total-item"],[1,"value-usd"],["class","total-item",4,"ngIf"],[1,"invoice-selection"],["appearance","outline",1,"full-width"],[3,"ngModelChange","selectionChange","ngModel"],[3,"value",4,"ngFor","ngForOf"],[1,"payment-amount-section"],[1,"currency-tabs"],[1,"tab-btn",3,"click"],[1,"input-wrapper"],["appearance","outline","class","full-width",4,"ngIf"],["class","exchange-rate-details",4,"ngIf"],["class","exchange-rate-details","style","margin-top: 4px;",4,"ngIf"],["class","change-section","style","margin-top: 15px; border-top: 1px dashed #ccc; padding-top: 10px;",4,"ngIf"],[1,"payment-methods"],[1,"custom-method-btn",3,"click"],[1,"payment-details",3,"hidden"],[2,"display","flex","gap","8px","margin-bottom","8px"],["appearance","outline",2,"flex","1"],["matInput","","placeholder","Ref #",3,"ngModelChange","ngModel"],[3,"ngModelChange","ngModel"],["value",""],["appearance","outline",3,"hidden"],["matInput","","placeholder","V-12345678 / 0412...",3,"ngModelChange","ngModel"],["matInput","","placeholder","\xDAltimos 4 d\xEDgitos o cuenta completa",3,"ngModelChange","ngModel"],[1,"actions"],["mat-button","",3,"click","disabled"],["mat-raised-button","","color","primary",3,"click","disabled","appLoading"],[1,"value-bs"],[3,"value"],["matTextPrefix",""],["matInput","","appMoneyInput","",3,"ngModelChange","ngModel"],[1,"exchange-rate-details"],[1,"rate-label"],["class","equivalent-hint",4,"ngIf"],[1,"equivalent-hint"],[1,"exchange-rate-details",2,"margin-top","4px"],[1,"rate-label",2,"color","#e02424"],[1,"change-section",2,"margin-top","15px","border-top","1px dashed #ccc","padding-top","10px"],["class","change-display","style","text-align: right; color: green; font-weight: bold; font-size: 1.1rem;",4,"ngIf"],[1,"change-display",2,"text-align","right","color","green","font-weight","bold","font-size","1.1rem"]],template:function(o,t){o&1&&(i(0,"div",0)(1,"h2",1),r(2),a(),i(3,"mat-dialog-content")(4,"div",2)(5,"div",3)(6,"label"),r(7,"Deuda Total (USD)"),a(),i(8,"span",4),r(9),f(10,"number"),a()(),g(11,ht,6,4,"div",5),a(),i(12,"div",6)(13,"mat-form-field",7)(14,"mat-label"),r(15,"Seleccionar Factura (Saldo en USD)"),a(),i(16,"mat-select",8),M("ngModelChange",function(c){return y(t.selectedInvoice,c)||(t.selectedInvoice=c),c}),u("selectionChange",function(c){return t.onInvoiceChange(c.value)}),g(17,xt,3,6,"mat-option",9),a()()(),i(18,"div",10)(19,"div",11)(20,"div",12),u("click",function(){return t.setCurrency("base")}),r(21,"Bs. "),a(),i(22,"div",12),u("click",function(){return t.setCurrency("alt")}),r(23,"$ USD "),a()(),i(24,"div",13),g(25,vt,6,1,"mat-form-field",14)(26,bt,6,1,"mat-form-field",14),a(),g(27,St,8,6,"div",15)(28,Pt,10,9,"div",16)(29,Et,6,3,"div",17),a(),i(30,"div",18)(31,"div",19),u("click",function(){return t.setPaymentMethod("cash")}),i(32,"mat-icon"),r(33,"payments"),a(),i(34,"span"),r(35,"Efectivo"),a()(),i(36,"div",19),u("click",function(){return t.setPaymentMethod("card")}),i(37,"mat-icon"),r(38,"credit_card"),a(),i(39,"span"),r(40,"Tarjeta"),a()(),i(41,"div",19),u("click",function(){return t.setPaymentMethod("paper")}),i(42,"mat-icon"),r(43,"smartphone"),a(),i(44,"span"),r(45,"Pago M\xF3vil"),a()(),i(46,"div",19),u("click",function(){return t.setPaymentMethod("transfer")}),i(47,"mat-icon"),r(48,"account_balance"),a(),i(49,"span"),r(50,"Transferencia"),a()()(),i(51,"div",20)(52,"div",21)(53,"mat-form-field",22)(54,"mat-label"),r(55,"Referencia"),a(),i(56,"input",23),M("ngModelChange",function(c){return y(t.reference,c)||(t.reference=c),c}),a()(),i(57,"mat-form-field",22)(58,"mat-label"),r(59,"Banco"),a(),i(60,"mat-select",24),M("ngModelChange",function(c){return y(t.selectedBankId,c)||(t.selectedBankId=c),c}),i(61,"mat-option",25),r(62,"Ninguno"),a(),g(63,Dt,2,4,"mat-option",9),a()()(),i(64,"mat-form-field",26)(65,"mat-label"),r(66,"C\xE9dula/Telf (Pago M\xF3vil)"),a(),i(67,"input",27),M("ngModelChange",function(c){return y(t.cedula,c)||(t.cedula=c),c}),a()(),i(68,"mat-form-field",26)(69,"mat-label"),r(70,"Cuenta de Destino"),a(),i(71,"input",28),M("ngModelChange",function(c){return y(t.account,c)||(t.account=c),c}),a()()()(),i(72,"mat-dialog-actions",29)(73,"button",30),u("click",function(){return t.onCancel()}),r(74,"Cancelar"),a(),i(75,"button",31),u("click",function(){return t.onConfirm()}),r(76," Confirmar Pago "),a()()()),o&2&&(l(2),C("Abono/Pago de Deuda - ",t.data.customer.name),l(7),C("$ ",h(10,33,t.data.customer.curdebt,t.totalFormat)),l(2),s("ngIf",t.data.exchangeRate),l(5),b("ngModel",t.selectedInvoice),l(),s("ngForOf",t.invoices),l(3),w("active",t.selectedCurrency==="base"),l(2),w("active",t.selectedCurrency==="alt"),l(3),s("ngIf",t.selectedCurrency==="base"),l(),s("ngIf",t.selectedCurrency==="alt"),l(),s("ngIf",t.data.exchangeRate),l(),s("ngIf",t.igtfAmountAlt>0),l(),s("ngIf",t.paymentMethod==="cash"),l(2),w("active",t.paymentMethod==="cash"),l(5),w("active",t.paymentMethod==="card"),l(5),w("active",t.paymentMethod==="paper"),l(5),w("active",t.paymentMethod==="transfer"),l(5),s("hidden",t.paymentMethod==="cash"),l(5),b("ngModel",t.reference),l(4),b("ngModel",t.selectedBankId),l(3),s("ngForOf",t.getFilteredBanks()),l(),s("hidden",t.paymentMethod!=="paper"),l(3),b("ngModel",t.cedula),l(),s("hidden",t.paymentMethod!=="transfer"),l(3),b("ngModel",t.account),l(2),s("disabled",t.isLoading),l(2),s("disabled",!t.isValid()||t.isLoading)("appLoading",t.isLoading))},dependencies:[R,B,O,N,z,L,H,X,tt,it,nt,J,Y,V,A,q,j,$,Fe,Q,G,Qe,Ge,Pe,ot,rt,U,D],styles:[".payment-container[_ngcontent-%COMP%]{padding:20px}.totals-summary[_ngcontent-%COMP%]{background:#f5f5f5;padding:15px;border-radius:8px;margin-bottom:20px;display:flex;justify-content:space-around}.total-item[_ngcontent-%COMP%]{text-align:center}.total-item[_ngcontent-%COMP%]   label[_ngcontent-%COMP%]{display:block;font-size:.8rem;color:#666}.total-item[_ngcontent-%COMP%]   span[_ngcontent-%COMP%]{font-size:1.25rem;font-weight:700;display:block}.value-usd[_ngcontent-%COMP%]{color:#d32f2f}.value-bs[_ngcontent-%COMP%]{color:#555;font-size:1.1rem!important}.invoice-selection[_ngcontent-%COMP%]{margin-bottom:24px}.payment-amount-section[_ngcontent-%COMP%]{margin:20px 0;padding:16px;background:#f9f9fb;border:1px solid #eef0f2;border-radius:8px}.currency-tabs[_ngcontent-%COMP%]{display:flex;gap:8px;margin-bottom:16px}.tab-btn[_ngcontent-%COMP%]{flex:1;height:40px;border-radius:8px;border:1px solid #ddd;background:#fff;cursor:pointer;font-weight:600;display:flex;align-items:center;justify-content:center;transition:all .2s;color:#666}.tab-btn.active[_ngcontent-%COMP%]{background:#3f51b5;color:#fff;border-color:#3f51b5}.exchange-rate-details[_ngcontent-%COMP%]{margin-top:12px;display:flex;flex-direction:column;gap:4px;padding-top:12px;border-top:1px dashed #ddd}.rate-label[_ngcontent-%COMP%]{font-size:.85rem;color:#3f51b5}.equivalent-hint[_ngcontent-%COMP%]{font-size:.9rem;color:#2e7d32}.payment-methods[_ngcontent-%COMP%]{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:24px;margin-bottom:20px}.custom-method-btn[_ngcontent-%COMP%]{height:70px;display:flex;flex-direction:column;align-items:center;justify-content:center;border:1px solid #ddd;border-radius:12px;cursor:pointer;background:#fff;transition:all .2s cubic-bezier(.4,0,.2,1);gap:4px;color:#555}.custom-method-btn[_ngcontent-%COMP%]   mat-icon[_ngcontent-%COMP%]{font-size:24px;width:24px;height:24px}.custom-method-btn[_ngcontent-%COMP%]   span[_ngcontent-%COMP%]{font-size:.85rem;font-weight:500}.custom-method-btn[_ngcontent-%COMP%]:hover{background:#f0f2f5}.custom-method-btn.active[_ngcontent-%COMP%]{background:#3f51b5;color:#fff;border-color:#3f51b5;box-shadow:0 4px 12px #3f51b54d;transform:translateY(-2px)}.actions[_ngcontent-%COMP%]{display:flex;justify-content:flex-end;gap:10px;padding:16px 24px!important}mat-form-field[_ngcontent-%COMP%]{width:100%}.payment-details[_ngcontent-%COMP%]{margin-bottom:16px;animation:_ngcontent-%COMP%_fadeIn .3s ease-out}@keyframes _ngcontent-%COMP%_fadeIn{0%{opacity:0;transform:translateY(5px)}to{opacity:1;transform:translateY(0)}}"],changeDetection:0})}return n})();var kt=()=>["expandedDetail"];function It(n,d){n&1&&(i(0,"th",26),r(1,"\xA0"),a())}function Tt(n,d){n&1&&(i(0,"mat-icon"),r(1,"keyboard_arrow_down"),a())}function Ft(n,d){n&1&&(i(0,"mat-icon"),r(1,"keyboard_arrow_up"),a())}function Bt(n,d){if(n&1){let e=E();i(0,"td",27)(1,"button",28),u("click",function(t){let m=x(e).$implicit,c=p();return v(c.toggleExpand(m,t))}),g(2,Tt,2,0,"mat-icon",29)(3,Ft,2,0,"mat-icon",29),a()()}if(n&2){let e=d.$implicit,o=p();l(2),s("ngIf",o.expandedElement!==e),l(),s("ngIf",o.expandedElement===e)}}function Ot(n,d){n&1&&(i(0,"th",30),r(1," C\xE9dula / RIF "),a())}function Rt(n,d){if(n&1&&(i(0,"td",27),r(1),a()),n&2){let e=d.$implicit;l(),C(" ",e.taxid," ")}}function At(n,d){n&1&&(i(0,"th",30),r(1," Nombre / Raz\xF3n Social "),a())}function Vt(n,d){if(n&1&&(i(0,"td",27),r(1),a()),n&2){let e=d.$implicit;l(),C(" ",e.name," ")}}function Wt(n,d){n&1&&(i(0,"th",30),r(1," Tel\xE9fono "),a())}function Ut(n,d){if(n&1&&(i(0,"td",27),r(1),f(2,"phoneFormat"),a()),n&2){let e=d.$implicit;l(),C(" ",be(2,1,e.phone)," ")}}function zt(n,d){n&1&&(i(0,"th",30),r(1," Total Abonado (USD) "),a())}function Lt(n,d){if(n&1&&(i(0,"small",35),r(1),f(2,"number"),a()),n&2){let e=p().$implicit,o=p();l(),C(" ",h(2,1,e.total_paid*o.currentExchangeRate,o.settingsService.getDecimalFormat("total"))," Bs. ")}}function Ht(n,d){if(n&1&&(i(0,"td",31)(1,"div",32)(2,"span",33),r(3),f(4,"number"),a(),g(5,Lt,3,4,"small",34),a()()),n&2){let e=d.$implicit,o=p();l(3),C("$ ",h(4,2,e.total_paid,o.settingsService.getDecimalFormat("total"))),l(2),s("ngIf",o.currentExchangeRate)}}function Nt(n,d){n&1&&(i(0,"th",30),r(1," Saldo Deudor (USD) "),a())}function $t(n,d){if(n&1&&(i(0,"small",35),r(1),f(2,"number"),a()),n&2){let e=p().$implicit,o=p();l(),C(" ",h(2,1,e.curdebt*o.currentExchangeRate,o.settingsService.getDecimalFormat("total"))," Bs. ")}}function jt(n,d){if(n&1&&(i(0,"td",31)(1,"div",32)(2,"span",36),r(3),f(4,"number"),a(),g(5,$t,3,4,"small",34),a()()),n&2){let e=d.$implicit,o=p();l(3),C("$ ",h(4,2,e.curdebt,o.settingsService.getDecimalFormat("total"))),l(2),s("ngIf",o.currentExchangeRate)}}function qt(n,d){n&1&&(i(0,"th",30),r(1," Acciones "),a())}function Gt(n,d){if(n&1){let e=E();i(0,"td",27)(1,"button",37),u("click",function(t){let m=x(e).$implicit,c=p();return t.stopPropagation(),v(c.openViewDialog(m))}),i(2,"mat-icon"),r(3,"visibility"),a()(),i(4,"button",38),u("click",function(t){let m=x(e).$implicit,c=p();return t.stopPropagation(),v(c.openHistoryDialog(m))}),i(5,"mat-icon"),r(6,"history"),a()(),i(7,"button",39),u("click",function(t){let m=x(e).$implicit,c=p();return t.stopPropagation(),v(c.openPaymentDialog(m))}),i(8,"mat-icon"),r(9,"payments"),a()()()}if(n&2){let e=p();l(7),s("disabled",!e.isCashOpened)("matTooltip",e.isCashOpened?"Abonar / Pagar":"Abra caja para recibir pagos")}}function Qt(n,d){n&1&&(i(0,"div",44)(1,"span",45),r(2,"Cargando facturas..."),a()())}function Yt(n,d){n&1&&(i(0,"div",44)(1,"span",45),r(2,"No hay facturas pendientes."),a()())}function Jt(n,d){if(n&1&&(i(0,"tr")(1,"td"),r(2),a(),i(3,"td"),r(4),a(),i(5,"td",49),r(6),f(7,"number"),a(),i(8,"td",50),r(9),f(10,"number"),a()()),n&2){let e=d.$implicit;l(2),k(e.dateInvoices),l(2),k(e.numberInvoice),l(2),C("$ ",h(7,4,e.paid,"1.2-2")),l(3),C("$ ",h(10,7,e.balance,"1.2-2"))}}function Kt(n,d){if(n&1&&(i(0,"table",46)(1,"thead")(2,"tr")(3,"th"),r(4,"Fecha"),a(),i(5,"th"),r(6,"N\xB0 Factura"),a(),i(7,"th",47),r(8,"Abonado (USD)"),a(),i(9,"th",47),r(10,"Saldo (USD)"),a()()(),i(11,"tbody"),g(12,Jt,11,10,"tr",48),a()()),n&2){let e=p().$implicit,o=p();l(12),s("ngForOf",o.invoicesMap[e.id])}}function Xt(n,d){if(n&1&&(i(0,"td",27)(1,"div",40)(2,"div",41),g(3,Qt,3,0,"div",42)(4,Yt,3,0,"div",42)(5,Kt,13,1,"table",43),a()()()),n&2){let e=d.$implicit,o=p();ue("colspan",o.displayedColumns.length),l(),s("@detailExpand",e==o.expandedElement?"expanded":"collapsed"),l(2),s("ngIf",!o.invoicesMap[e.id]),l(),s("ngIf",o.invoicesMap[e.id]&&o.invoicesMap[e.id].length===0),l(),s("ngIf",o.invoicesMap[e.id]&&o.invoicesMap[e.id].length>0)}}function Zt(n,d){n&1&&oe(0,"tr",51)}function en(n,d){if(n&1){let e=E();i(0,"tr",52),u("click",function(t){let m=x(e).$implicit,c=p();return v(c.toggleExpand(m,t))}),a()}if(n&2){let e=d.$implicit,o=p();w("expanded-row",o.expandedElement===e)}}function tn(n,d){n&1&&oe(0,"tr",53)}function nn(n,d){n&1&&(i(0,"div",54),r(1," No se encontraron clientes con saldo pendiente. "),a())}var ai=(()=>{class n{customerService=_(te);settingsService=_(K);dialog=_(et);snackBar=_(W);decimalPipe=_(D);datePipe=_(le);phoneFormatPipe=_(ne);salesService=_(Z);cashService=_(ee);cdr=_(F);customers=[];searchText="";displayedColumns=["expand","taxid","name","phone","total_paid","curdebt","actions"];expandedElement=null;invoicesMap={};isCashOpened=!1;totalElements=0;pageSize=50;currentExchangeRate=1;paginator;async ngOnInit(){this.loadCustomers(),this.isCashOpened=await this.cashService.checkStatus(),this.loadExchangeRate()}loadExchangeRate(){this.salesService.getCurrencies().subscribe(e=>{let o=e.find(t=>t.code==="USD");o&&(this.currentExchangeRate=o.exchange_rate)})}loadCustomers(e=1){this.customerService.getAll(e,this.pageSize,this.searchText,!0).subscribe(o=>{this.customers=o.data,this.totalElements=o.total})}onPageChange(e){this.loadCustomers(e.pageIndex+1)}openEditDialog(e){this.dialog.open(ce,{width:"600px",maxWidth:"95vw",data:{customer:e}}).afterClosed().subscribe(t=>{t&&(this.loadCustomers(),this.snackBar.open("Cliente actualizado","Cerrar",{duration:3e3}))})}openViewDialog(e){this.dialog.open(ce,{width:"600px",maxWidth:"95vw",data:{customer:e,viewOnly:!0}})}async openPaymentDialog(e){if(this.isCashOpened=await this.cashService.checkStatus(),!this.isCashOpened){this.snackBar.open("Debe tener una sesi\xF3n de caja abierta para recibir pagos.","Cerrar",{duration:5e3});return}this.salesService.getCurrencies().subscribe(o=>{let t=o.find(ie=>ie.code==="USD"),m=t?t.exchange_rate:1;this.dialog.open(mt,{width:"650px",maxWidth:"95vw",data:{customer:e,exchangeRate:m}}).afterClosed().subscribe(ie=>{if(ie===!0){let dt=this.paginator?this.paginator.pageIndex+1:1;this.customerService.getAll(dt,this.pageSize,this.searchText,!0).subscribe(se=>{if(this.customers=se.data,this.totalElements=se.total,this.expandedElement&&this.expandedElement.id===e.id){let ae=this.customers.find(ct=>ct.id===e.id);ae&&(this.expandedElement=ae,this.reloadInvoices(ae))}else delete this.invoicesMap[e.id];this.cdr.markForCheck()}),this.snackBar.open("Pago procesado correctamente","Cerrar",{duration:3e3})}})})}openHistoryDialog(e){this.dialog.open(lt,{width:"900px",maxWidth:"95vw",data:{customer:e}})}exportPdf(){let e=window.open("","_blank","width=800,height=600");if(!e)return;let o=this.customers.map(m=>`
        <tr>
            <td>${m.taxid||""}</td>
            <td>${m.name}</td>
            <td>${this.phoneFormatPipe.transform(m.phone)}</td>
            <td style="text-align: right; color: red; font-weight: bold;">
                ${this.decimalPipe.transform(m.curdebt,this.settingsService.getDecimalFormat("total"))}
            </td>
        </tr>
    `).join(""),t=`
        <html>
        <head>
            <title>Reporte de CxC Clientes</title>
            <style>
                body { font-family: Arial, sans-serif; font-size: 12px; }
                h1 { text-align: center; color: #333; }
                .metadata { margin-bottom: 20px; text-align: center; color: #666; }
                table { width: 100%; border-collapse: collapse; margin-top: 10px; }
                th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                th { background-color: #f2f2f2; font-weight: bold; text-align: center; }
                tr:nth-child(even) { background-color: #f9f9f9; }
            </style>
        </head>
        <body>
            <h1>Reporte de CxC Clientes (Con Saldo Pendiente)</h1>
            <div class="metadata">
                <strong>Generado:</strong> ${this.datePipe.transform(new Date,"dd/MM/yyyy HH:mm")}
            </div>
            <table>
                <thead>
                    <tr>
                        <th>C\xE9dula / RIF</th>
                        <th>Nombre / Raz\xF3n Social</th>
                        <th>Tel\xE9fono</th>
                        <th>Saldo Deudor</th>
                    </tr>
                </thead>
                <tbody>
                    ${o}
                </tbody>
            </table>
            <script>
                window.onload = function() { window.print(); window.close(); }
            <\/script>
        </body>
        </html>
    `;e.document.write(t),e.document.close()}toggleExpand(e,o){o.stopPropagation(),this.expandedElement=this.expandedElement===e?null:e,this.expandedElement&&!this.invoicesMap[e.id]&&this.reloadInvoices(e)}reloadInvoices(e){this.customerService.getInvoices(e.id).subscribe(o=>{this.invoicesMap[e.id]=o})}static \u0275fac=function(o){return new(o||n)};static \u0275cmp=T({type:n,selectors:[["app-cxc-clientes"]],viewQuery:function(o,t){if(o&1&&Ce(Ye,5),o&2){let m;_e(m=fe())&&(t.paginator=m.first)}},features:[xe([D,le,ne])],decls:48,vars:9,consts:[[1,"container"],[1,"main-card"],[1,"header-actions"],["appearance","outline",1,"search-field"],["matInput","","placeholder","Nombre, C\xE9dula o RIF",3,"ngModelChange","keyup.enter","ngModel"],["mat-icon-button","","matSuffix","",3,"click"],["mat-stroked-button","",3,"click"],[1,"table-container"],["mat-table","","multiTemplateDataRows","",1,"full-width-table",3,"dataSource"],["matColumnDef","expand"],["mat-header-cell","","aria-label","row actions",4,"matHeaderCellDef"],["mat-cell","",4,"matCellDef"],["matColumnDef","taxid"],["mat-header-cell","",4,"matHeaderCellDef"],["matColumnDef","name"],["matColumnDef","phone"],["matColumnDef","total_paid"],["mat-cell","","class","debt-cell",4,"matCellDef"],["matColumnDef","curdebt"],["matColumnDef","actions"],["matColumnDef","expandedDetail"],["mat-header-row","",4,"matHeaderRowDef"],["mat-row","","class","element-row",3,"expanded-row","click",4,"matRowDef","matRowDefColumns"],["mat-row","","class","detail-row",4,"matRowDef","matRowDefColumns"],[3,"page","length","pageSize"],["class","empty-msg",4,"ngIf"],["mat-header-cell","","aria-label","row actions"],["mat-cell",""],["mat-icon-button","","aria-label","expand row",3,"click"],[4,"ngIf"],["mat-header-cell",""],["mat-cell","",1,"debt-cell"],[1,"debt-container"],[1,"paid-amount"],["class","bs-equivalent",4,"ngIf"],[1,"bs-equivalent"],[1,"usd-amount"],["mat-icon-button","","color","accent","title","Ver Detalle",3,"click"],["mat-icon-button","","color","primary","title","Ver Historial de Pagos",3,"click"],["mat-icon-button","","color","warn",3,"click","disabled","matTooltip"],[1,"element-detail"],[1,"invoices-list"],["style","padding: 10px; text-align: center;",4,"ngIf"],["class","invoices-table",4,"ngIf"],[2,"padding","10px","text-align","center"],[2,"color","#666","font-style","italic"],[1,"invoices-table"],[2,"text-align","right"],[4,"ngFor","ngForOf"],[1,"invoice-paid"],[1,"invoice-amount"],["mat-header-row",""],["mat-row","",1,"element-row",3,"click"],["mat-row","",1,"detail-row"],[1,"empty-msg"]],template:function(o,t){o&1&&(i(0,"div",0)(1,"mat-card",1)(2,"mat-card-header")(3,"mat-card-title"),r(4,"CxC Clientes (Deudores)"),a(),i(5,"div",2)(6,"mat-form-field",3)(7,"mat-label"),r(8,"Buscar cliente..."),a(),i(9,"input",4),M("ngModelChange",function(c){return y(t.searchText,c)||(t.searchText=c),c}),u("keyup.enter",function(){return t.loadCustomers()}),a(),i(10,"button",5),u("click",function(){return t.loadCustomers()}),i(11,"mat-icon"),r(12,"search"),a()()(),i(13,"button",6),u("click",function(){return t.exportPdf()}),i(14,"mat-icon"),r(15,"picture_as_pdf"),a(),r(16," Exportar Reporte "),a()()(),i(17,"mat-card-content")(18,"div",7)(19,"table",8),S(20,9),g(21,It,2,0,"th",10)(22,Bt,4,2,"td",11),P(),S(23,12),g(24,Ot,2,0,"th",13)(25,Rt,2,1,"td",11),P(),S(26,14),g(27,At,2,0,"th",13)(28,Vt,2,1,"td",11),P(),S(29,15),g(30,Wt,2,0,"th",13)(31,Ut,3,3,"td",11),P(),S(32,16),g(33,zt,2,0,"th",13)(34,Ht,6,5,"td",17),P(),S(35,18),g(36,Nt,2,0,"th",13)(37,jt,6,5,"td",17),P(),S(38,19),g(39,qt,2,0,"th",13)(40,Gt,10,2,"td",11),P(),S(41,20),g(42,Xt,6,5,"td",11),P(),g(43,Zt,1,0,"tr",21)(44,en,1,2,"tr",22)(45,tn,1,0,"tr",23),a(),i(46,"app-shared-paginator",24),u("page",function(c){return t.onPageChange(c)}),a()(),g(47,nn,2,0,"div",25),a()()()),o&2&&(l(9),b("ngModel",t.searchText),l(10),s("dataSource",t.customers),l(24),s("matHeaderRowDef",t.displayedColumns),l(),s("matRowDefColumns",t.displayedColumns),l(),s("matRowDefColumns",ve(8,kt)),l(),s("length",t.totalElements)("pageSize",t.pageSize),l(),s("ngIf",t.customers.length===0))},dependencies:[R,B,O,qe,Ae,We,He,Ue,Ve,Ne,ze,Le,$e,je,V,A,we,J,Y,Te,Ee,ke,Ie,De,Q,G,j,$,Be,q,N,z,L,H,X,U,Re,Oe,Je,Ke,D,ne],styles:[".container[_ngcontent-%COMP%]{padding:20px}.main-card[_ngcontent-%COMP%]{padding:10px}.header-actions[_ngcontent-%COMP%]{display:flex;align-items:center;gap:20px;margin-left:auto}.search-field[_ngcontent-%COMP%]{width:300px;margin-bottom:-1.25em}.full-width-table[_ngcontent-%COMP%]{width:100%;margin-top:20px}.empty-msg[_ngcontent-%COMP%]{padding:40px;text-align:center;color:#888;font-style:italic}mat-card-header[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}.debt-cell[_ngcontent-%COMP%]{text-align:right}.debt-container[_ngcontent-%COMP%]{display:flex;flex-direction:column;align-items:flex-end}.usd-amount[_ngcontent-%COMP%]{color:#d32f2f;font-weight:700;font-size:1rem}.paid-amount[_ngcontent-%COMP%]{color:#388e3c;font-weight:700;font-size:1rem}.bs-equivalent[_ngcontent-%COMP%]{color:#757575;font-size:.75rem}.table-container[_ngcontent-%COMP%]{overflow-x:auto}tr.element-row[_ngcontent-%COMP%]:not(.expanded-row):hover{background:#f5f5f5}tr.element-row[_ngcontent-%COMP%]:not(.expanded-row):active{background:#efefef}.element-row[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]{border-bottom-width:0}.detail-row[_ngcontent-%COMP%]{height:0}.element-detail[_ngcontent-%COMP%]{overflow:hidden;display:flex;width:100%;border-top:1px solid #eee;background:#fafafa}.invoices-list[_ngcontent-%COMP%]{width:100%;padding:16px}.invoices-table[_ngcontent-%COMP%]{width:100%;border-collapse:collapse;font-size:.9em}.invoices-table[_ngcontent-%COMP%]   th[_ngcontent-%COMP%]{text-align:left;padding:8px;border-bottom:2px solid #ddd;color:#666}.invoices-table[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]{padding:8px;border-bottom:1px solid #ddd}.invoice-amount[_ngcontent-%COMP%]{text-align:right;font-weight:500;color:#d32f2f}.invoice-paid[_ngcontent-%COMP%]{text-align:right;font-weight:500;color:#388e3c}"],data:{animation:[ye("detailExpand",[de("collapsed,void",me({height:"0px",minHeight:"0",visibility:"hidden"})),de("expanded",me({height:"*",visibility:"visible"})),Se("expanded <=> collapsed",Me("225ms cubic-bezier(0.4, 0.0, 0.2, 1)"))])]}})}return n})();export{ai as CxCClientesComponent};
