import{a as m}from"./chunk-DEAF3FKS.js";import{a as f}from"./chunk-34EVCEMG.js";import{a as b}from"./chunk-7KQW3R3P.js";import{a as g}from"./chunk-DGQM6DPS.js";import{a as T}from"./chunk-YCMZOG5D.js";import{d as S}from"./chunk-3TNWXQYU.js";import{S as k,W as v,_ as l,f as o}from"./chunk-WSMHJDAT.js";import{a as p}from"./chunk-C6Q5SG76.js";var X=(()=>{class u{http;settingsService;discountService;configService;warehouseService;apiUrl=`${T.apiUrl}/sales`;tickets=[];activeTicketIndex=0;STORAGE_KEY="mangopos_sales_state";currentLinesSubject=new o([]);currentLines$=this.currentLinesSubject.asObservable();ticketsSubject=new o(this.tickets);tickets$=this.ticketsSubject.asObservable();activeTicketIndexSubject=new o(0);activeTicketIndex$=this.activeTicketIndexSubject.asObservable();exchangeRateSubject=new o(1);exchangeRate$=this.exchangeRateSubject.asObservable();selectedLineIndexSubject=new o(-1);selectedLineIndex$=this.selectedLineIndexSubject.asObservable();selectedCustomerSubject=new o(null);selectedCustomer$=this.selectedCustomerSubject.asObservable();notesSubject=new o("");notes$=this.notesSubject.asObservable();currentLocationIdSubject=new o(null);currentLocationId$=this.currentLocationIdSubject.asObservable();currentLocationNameSubject=new o("");currentLocationName$=this.currentLocationNameSubject.asObservable();constructor(t,e,i,s,c){this.http=t,this.settingsService=e,this.discountService=i,this.configService=s,this.warehouseService=c,this.loadFromStorage(),this.resolveCurrentLocation(),this.updateState()}createEmptyTicket(){return{id:Math.random().toString(36).substring(2,9),lines:[],selectedCustomer:null,selectedLineIndex:-1,notes:"",globalDiscount:0,globalDiscountType:"PERCENT"}}resolveCurrentLocation(){let t=this.configService.getConfig();t&&this.warehouseService.getAll().subscribe(e=>{let i=null;if(t.warehouse_id&&(i=e.find(s=>s.id===t.warehouse_id)),!i){let s=t.location_name?.toLowerCase();i=e.find(c=>c.name.toLowerCase()===s)}i||(t.installation_type==="factory"?(t.factory_warehouse_id&&(i=e.find(s=>s.id===t.factory_warehouse_id)),i||(i=e.find(s=>s.type==="factory"))):i=e.find(s=>s.type==="pos")),!i&&e.length>0&&(i=e[0]),i?(console.log(`Sales resolved to location: ${i.name} (ID: ${i.id})`),this.setCurrentLocation(i.id,i.name),this.tickets.forEach(s=>{s.location_id||(s.location_id=i.id)}),this.saveToStorage()):console.warn("Could not resolve location for sales. Using default.")})}setCurrentLocation(t,e){this.currentLocationIdSubject.next(t),this.currentLocationNameSubject.next(e)}getCatalog(){let t=this.currentLocationIdSubject.value||1;return this.http.get(`${this.apiUrl}/catalog`,{params:{locationId:t.toString()}})}getCurrencies(){return this.http.get(`${this.apiUrl}/currencies`)}createSale(t){return this.http.post(this.apiUrl,t).pipe(k(()=>this.clearTicket()))}createDebtPayment(t){return this.http.post(`${this.apiUrl}/debt-payment`,t)}addTicket(){if(this.tickets.length>=10)return;let t=this.createEmptyTicket();this.tickets.push(t),this.activeTicketIndex=this.tickets.length-1,this.updateState()}removeTicket(t){if(this.tickets.length<=1){this.clearTicket();return}this.tickets.splice(t,1),this.activeTicketIndex>=this.tickets.length&&(this.activeTicketIndex=this.tickets.length-1),this.updateState()}setActiveTicket(t){t>=0&&t<this.tickets.length&&(this.activeTicketIndex=t,this.updateState())}updateState(){this.ticketsSubject.next([...this.tickets]),this.activeTicketIndexSubject.next(this.activeTicketIndex),this.updateActiveTicketObservables()}updateActiveTicketObservables(){let t=this.tickets[this.activeTicketIndex];this.currentLinesSubject.next([...t.lines]),this.selectedLineIndexSubject.next(t.selectedLineIndex),this.selectedCustomerSubject.next(t.selectedCustomer),this.notesSubject.next(t.notes||""),this.saveToStorage()}saveToStorage(){let t={tickets:this.tickets,activeTicketIndex:this.activeTicketIndex};localStorage.setItem(this.STORAGE_KEY,JSON.stringify(t))}get currentLocationId(){return this.currentLocationIdSubject.value}getActiveTicketIndex(){return this.activeTicketIndex}loadFromStorage(){let t=localStorage.getItem(this.STORAGE_KEY);if(t)try{let e=JSON.parse(t);if(e.tickets&&e.tickets.length>0){this.tickets=e.tickets,this.activeTicketIndex=e.activeTicketIndex||0;return}}catch(e){console.error("Error loading sales state from storage",e)}this.tickets=[this.createEmptyTicket()],this.activeTicketIndex=0}addLine(t){let e=this.tickets[this.activeTicketIndex],i=e.lines,s=i.findIndex(c=>c.product_id===t.product_id);s>-1?i[s].units+=t.units:i.push(p({},t)),e.selectedLineIndex=i.length-1,this.updateState()}addLineWithDiscount(t,e,i,s){this.discountService.getApplicableDiscount(t.id,i).subscribe(c=>{let n=0,r="PERCENT";c&&(n=c.quantity,r=c.percentage?"PERCENT":"FIXED"),this.addLine({product_id:t.id,product_name:t.name,units:e,price:t.pricesell,taxid:t.tax_id||t.taxcat,tax_rate:t.tax_rate||.16,discount:r==="PERCENT"?n/100:n,discount_type:r,selectedComponents:s})})}refreshAllLineDiscounts(t){this.tickets[this.activeTicketIndex].lines.forEach((s,c)=>{this.discountService.getApplicableDiscount(s.product_id,t).subscribe(n=>{if(n){let r=n.percentage?"PERCENT":"FIXED";this.updateLineDiscount(c,n.quantity,r)}else this.updateLineDiscount(c,0,"PERCENT")})})}removeLine(t){let e=this.tickets[this.activeTicketIndex],i=e.lines;i.splice(t,1),e.selectedLineIndex>=i.length&&(e.selectedLineIndex=i.length-1),this.updateState()}updateLineQuantity(t,e){let s=this.tickets[this.activeTicketIndex].lines;s[t]&&(s[t].units=e,s[t].units<=1e-4?this.removeLine(t):this.updateState())}updateLinePrice(t,e){let s=this.tickets[this.activeTicketIndex].lines;s[t]&&(s[t].price=e,this.updateState())}updateLineDiscount(t,e,i="PERCENT"){let c=this.tickets[this.activeTicketIndex].lines;c[t]&&(c[t].discount=i==="PERCENT"?e/100:e,c[t].discount_type=i,this.updateState())}clearTicket(){let t=this.tickets[this.activeTicketIndex];t.lines=[],t.selectedCustomer=null,t.selectedLineIndex=-1,this.updateState()}setSelectedCustomer(t){this.tickets[this.activeTicketIndex].selectedCustomer=t,this.selectedCustomerSubject.next(t)}getSelectedCustomer(){return this.tickets[this.activeTicketIndex].selectedCustomer}setNotes(t){this.tickets[this.activeTicketIndex].notes=t,this.notesSubject.next(t)}getNotes(){return this.tickets[this.activeTicketIndex].notes||""}setGlobalDiscount(t,e="PERCENT"){let i=this.tickets[this.activeTicketIndex];i.globalDiscount=e==="PERCENT"?t/100:t,i.globalDiscountType=e,this.updateState()}getGlobalDiscount(){return this.tickets[this.activeTicketIndex].globalDiscount||0}getGlobalDiscountType(){return this.tickets[this.activeTicketIndex].globalDiscountType||"PERCENT"}getTotal(){let t=this.tickets[this.activeTicketIndex],e=this.exchangeRateSubject.value,s=this.settingsService.getSettings()?.total_decimals||2,c=t.lines.reduce((r,a)=>{let h=a.price;if(a.discount)if(a.discount_type==="FIXED")h=Math.max(0,a.price-a.discount);else if(a.discount_type==="FIXED_VES"){let I=a.discount/e;h=Math.max(0,a.price-I)}else h=a.price*(1-a.discount);let d=a.units*h,x=d*(a.tax_rate||0);return r+d+x},0),n=c;if(t.globalDiscount)if(t.globalDiscountType==="FIXED")n=Math.max(0,c-t.globalDiscount);else if(t.globalDiscountType==="FIXED_VES"){let r=t.globalDiscount/e;n=Math.max(0,c-r)}else n=c*(1-t.globalDiscount);return parseFloat(n.toFixed(s))}setExchangeRate(t){this.exchangeRateSubject.next(t)}getExchangeRate(){return this.exchangeRateSubject.value}setSelectedLineIndex(t){this.tickets[this.activeTicketIndex].selectedLineIndex=t,this.selectedLineIndexSubject.next(t)}getSelectedLineIndex(){return this.tickets[this.activeTicketIndex].selectedLineIndex}refreshCartPrices(t){let e=!1;return this.tickets.forEach(i=>{i.lines.forEach(s=>{let c=t.find(n=>n.id===s.product_id);c&&c.pricesell!==s.price&&(s.price=c.pricesell,e=!0)})}),e&&this.updateState(),e}static \u0275fac=function(e){return new(e||u)(l(S),l(g),l(f),l(b),l(m))};static \u0275prov=v({token:u,factory:u.\u0275fac,providedIn:"root"})}return u})();export{X as a};
