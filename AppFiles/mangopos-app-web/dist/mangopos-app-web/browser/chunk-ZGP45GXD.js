import{a as Qe}from"./chunk-44A6ZDZO.js";import{a as b,b as ze}from"./chunk-R7JIR2Y5.js";import{a as Ke}from"./chunk-5MBFWMTP.js";import{a as ke}from"./chunk-7KQW3R3P.js";import"./chunk-HIZ742YJ.js";import{a as Ge}from"./chunk-RFRKPPY3.js";import{c as He,h as je}from"./chunk-Z6YHTX75.js";import{a as Z,b as ee}from"./chunk-26KDQVR5.js";import{a as qe}from"./chunk-DGQM6DPS.js";import{a as ve}from"./chunk-SCPRHZYR.js";import{a as Ae,b as We,c as $e,d as Le}from"./chunk-N7P7XLP2.js";import{d as z}from"./chunk-GRESZPIF.js";import"./chunk-EQXJNMRX.js";import{b as Ce,c as Se}from"./chunk-APXOZHQA.js";import{a as we,b as Pe,c as Ee,d as Te,e as De,f as Ie,g as Be,h as Fe,i as Oe,j as Ve,l as Ue}from"./chunk-VJGP4MMT.js";import{a as Re,b as Ne}from"./chunk-VNZMNOUU.js";import"./chunk-YCMZOG5D.js";import{a as pe,c as ue,h as fe}from"./chunk-ZWM7H6SC.js";import{a as be}from"./chunk-PALJ6VDH.js";import"./chunk-TEMJ73U5.js";import{d as K}from"./chunk-52A733DE.js";import"./chunk-GPHRSLLH.js";import{b as ge,f as _e,i as he,j as Me}from"./chunk-EWTXOCXT.js";import{b as te,d as D,f as ne,g as ie,j as oe,k as re,n as ae,o as ce,u as le,w as me,x as de,y as se}from"./chunk-AVLO2MYP.js";import{a as xe,b as ye}from"./chunk-JI7GBIO6.js";import"./chunk-VTP6RNFS.js";import{H as Q,I as J,J as X,K as Y}from"./chunk-M7DMR53X.js";import"./chunk-JAVK727W.js";import"./chunk-3TNWXQYU.js";import"./chunk-UWUK32S4.js";import{k as $,l as L,s as H,u as j,v as G}from"./chunk-ZD4QWOHN.js";import{$ as g,$b as N,D as O,Fb as d,Gb as r,Hb as o,Ib as y,Mb as M,Nb as C,Pb as w,Q as V,Ub as S,Wa as l,Wb as f,_b as R,ac as q,e as I,ea as s,ec as A,fa as p,ic as c,jb as U,jc as W,kc as _,lc as B,nc as P,oc as E,pb as u,pc as T,vc as x,xc as F,zc as k}from"./chunk-WSMHJDAT.js";import"./chunk-C6Q5SG76.js";var Je=["barcodeInput"];function Xe(i,m){if(i&1&&(r(0,"mat-option",36),c(1),o()),i&2){let e=m.$implicit;d("value",e.id),l(),_(" ",e.name," ")}}function Ye(i,m){if(i&1&&(r(0,"mat-option",36),c(1),o()),i&2){let e=m.$implicit;d("value",e),l(),B(" ",e.name," (",e.sign>0?"Entrada":"Salida",") ")}}function Ze(i,m){i&1&&(r(0,"div",37),c(1," Seleccione un producto para agregar "),o())}function et(i,m){if(i&1){let e=w();M(0),r(1,"div",38)(2,"strong"),c(3),o(),c(4),y(5,"br"),c(6),x(7,"currency"),o(),r(8,"mat-form-field",39)(9,"mat-label"),c(10,"Unidades"),o(),r(11,"input",40),T("ngModelChange",function(t){s(e);let a=f();return E(a.currentUnits,t)||(a.currentUnits=t),p(t)}),o()(),r(12,"mat-form-field",39)(13,"mat-label"),c(14,"Precio"),o(),r(15,"input",41),T("ngModelChange",function(t){s(e);let a=f();return E(a.currentPrice,t)||(a.currentPrice=t),p(t)}),o()(),r(16,"button",42),S("click",function(){s(e);let t=f();return p(t.addLine())}),r(17,"mat-icon"),c(18,"add"),o()(),C()}if(i&2){let e=f();l(3),W(e.currentProduct.name),l(),_(" (",e.currentProduct.reference,") "),l(2),_(" Precio: ",k(7,6,e.currentPrice,"USD","$ ",e.settingsService.getDecimalFormat("price"))," "),l(5),P("ngModel",e.currentUnits),l(4),P("ngModel",e.currentPrice),l(),d("disabled",e.currentUnits<=0)}}function tt(i,m){i&1&&(r(0,"th",43),c(1," Producto "),o())}function nt(i,m){if(i&1&&(r(0,"td",44),c(1),o()),i&2){let e=m.$implicit;l(),_(" ",e.product.name," ")}}function it(i,m){i&1&&(r(0,"th",43),c(1," Unidades "),o())}function ot(i,m){if(i&1&&(r(0,"td",44),c(1),x(2,"number"),o()),i&2){let e=m.$implicit,n=f();l(),_(" ",F(2,1,e.units,n.settingsService.getDecimalFormat("quantity"))," ")}}function rt(i,m){i&1&&(r(0,"th",43),c(1," Precio "),o())}function at(i,m){if(i&1&&(r(0,"td",44),c(1),x(2,"currency"),o()),i&2){let e=m.$implicit,n=f();l(),_(" ",k(2,1,e.price,"USD","$ ",n.settingsService.getDecimalFormat("price"))," ")}}function ct(i,m){i&1&&(r(0,"th",43),c(1," Subtotal "),o())}function lt(i,m){if(i&1&&(r(0,"td",44),c(1),x(2,"currency"),o()),i&2){let e=m.$implicit,n=f();l(),_(" ",k(2,1,e.subtotal,"USD","$ ",n.settingsService.getDecimalFormat("total"))," ")}}function mt(i,m){i&1&&y(0,"th",43)}function dt(i,m){if(i&1){let e=w();r(0,"td",44)(1,"button",45),S("click",function(){let t=s(e).index,a=f();return p(a.removeLine(t))}),r(2,"mat-icon"),c(3,"delete"),o()()()}}function st(i,m){i&1&&y(0,"tr",46)}function pt(i,m){i&1&&y(0,"tr",47)}function ut(i,m){i&1&&(r(0,"div",48),c(1," No hay productos en la lista "),o())}var Yt=(()=>{class i{headerForm;locations=[];reasons=b.getAll();lines=[];displayedColumns=["product","units","price","subtotal","actions"];currentProduct=null;currentUnits=1;currentPrice=0;barcode="";barcodeInput;barcodeSubject=new I;destroy$=new I;fb=g(me);stockService=g(ze);productService=g(Ke);dialog=g(He);snackBar=g(Z);settingsService=g(qe);configService=g(ke);constructor(){this.headerForm=this.fb.group({date:[new Date,D.required],location:[null,D.required],reason:[this.reasons[0],D.required]})}ngOnInit(){this.stockService.getLocations().subscribe(e=>{let n=this.configService.getConfig();n?.installation_type==="pos"?this.locations=e.filter(t=>t.name===n.location_name):this.locations=e.filter(t=>t.type==="factory"),this.locations.length>0&&this.headerForm.patchValue({location:this.locations[0].id})}),setTimeout(()=>this.focusBarcode(),500),this.barcodeSubject.pipe(O(400),V(this.destroy$)).subscribe(e=>{e&&e.length>=3&&this.processBarcode(e)})}ngOnDestroy(){this.destroy$.next(),this.destroy$.complete()}onReasonChange(){this.currentProduct&&this.updateSuggestedPrice()}openProductSelector(){this.dialog.open(Qe,{width:"90%",maxWidth:"1100px",height:"85%",data:{locationId:this.headerForm.get("location")?.value}}).afterClosed().subscribe(n=>{if(n){if(n.typeproduct==="KI"||n.typeproduct==="CO"||!!(n.servicio&&n.servicio!=="0"&&n.servicio!==!1)){this.snackBar.open("No se permite gestionar stock para este tipo de producto (Kit, Compuesto o Servicio)","Cerrar",{duration:4e3});return}this.currentProduct=n,this.currentUnits=1,this.updateSuggestedPrice()}})}onBarcodeEnter(e){let n=e.target.value?.trim();if(!n){this.barcode="";return}this.processBarcode(n)}onBarcodeChange(e){let n=e?.trim();n&&this.barcodeSubject.next(n)}processBarcode(e){this.productService.getAll(1,1,{search:e}).subscribe(n=>{if(n.data&&n.data.length>0){let t=n.data.find(a=>a.code===e||a.reference===e)||n.data[0];if(t.code===e||t.reference===e){if(t.typeproduct==="KI"||t.typeproduct==="CO"||!!(t.servicio&&t.servicio!=="0"&&t.servicio!==!1)){this.snackBar.open(`No se permite gestionar stock para "${t.name}" (Kit, Compuesto o Servicio)`,"Cerrar",{duration:4e3}),this.barcode="";return}this.currentProduct=t,this.currentUnits=1,this.updateSuggestedPrice(),this.barcode="",this.snackBar.open(`Producto: ${t.name}`,"OK",{duration:1500})}else this.barcode=""}else this.barcode=""})}focusBarcode(){this.barcodeInput&&this.barcodeInput.nativeElement.focus()}updateSuggestedPrice(){if(!this.currentProduct)return;let e=this.headerForm.get("reason")?.value;e.key===b.IN_PURCHASE.key||e.key===b.OUT_REFUND.key||e.key===b.OUT_BREAK.key||e.key===b.OUT_CONSUMPTION.key?this.currentPrice=this.currentProduct.pricebuy:this.currentPrice=this.currentProduct.pricesell}addLine(){if(this.currentProduct&&this.currentUnits>0){let e={product:this.currentProduct,units:this.currentUnits,price:this.currentPrice,subtotal:this.currentUnits*this.currentPrice};this.lines=[...this.lines,e],this.currentProduct=null,this.currentUnits=1,this.currentPrice=0}}removeLine(e){this.lines.splice(e,1),this.lines=[...this.lines]}getTotalUnits(){return this.lines.reduce((e,n)=>e+n.units,0)}getTotalAmount(){return this.lines.reduce((e,n)=>e+n.units*n.price,0)}saveEverything(){if(this.headerForm.invalid||this.lines.length===0)return;let e=this.headerForm.value,n=e.reason,t={date:e.date,location:e.location,reason:n.key,lines:this.lines.map(a=>({product:a.product.id,units:a.units*n.sign,price:a.price,attributesetinstance_id:null}))};this.stockService.createBulkMovement(t).subscribe({next:a=>{this.snackBar.open("Movimientos guardados correctamente","Cerrar",{duration:3e3}),this.lines=[]},error:a=>{console.error(a),this.snackBar.open("Error al guardar: "+a.message,"Cerrar",{duration:5e3})}})}static \u0275fac=function(n){return new(n||i)};static \u0275cmp=U({type:i,selectors:[["app-stock-management"]],viewQuery:function(n,t){if(n&1&&R(Je,5),n&2){let a;N(a=q())&&(t.barcodeInput=a.first)}},decls:67,vars:23,consts:[["picker",""],["barcodeInput",""],[1,"container"],[1,"header-card"],[1,"header-form",3,"formGroup"],[1,"row"],["appearance","outline"],["matInput","","formControlName","date","required","",3,"matDatepicker"],["matIconSuffix","",3,"for"],["formControlName","location","required",""],[3,"value",4,"ngFor","ngForOf"],["appearance","outline",1,"reason-field"],["formControlName","reason","required","",3,"selectionChange"],[1,"input-card"],[1,"input-row"],[1,"barcode-container"],[1,"barcode-icon"],["type","text","placeholder","Escanear...",1,"barcode-input",3,"ngModelChange","keyup.enter","ngModel"],["mat-raised-button","","color","primary","type","button",3,"click"],["class","info-text",4,"ngIf"],[4,"ngIf"],[1,"table-container","mat-elevation-z2"],["mat-table","",3,"dataSource"],["matColumnDef","product"],["mat-header-cell","",4,"matHeaderCellDef"],["mat-cell","",4,"matCellDef"],["matColumnDef","units"],["matColumnDef","price"],["matColumnDef","subtotal"],["matColumnDef","actions"],["mat-header-row","",4,"matHeaderRowDef"],["mat-row","",4,"matRowDef","matRowDefColumns"],["class","empty-state",4,"ngIf"],[1,"footer-actions"],[1,"totals"],["mat-raised-button","","color","primary","size","large",3,"click","disabled"],[3,"value"],[1,"info-text"],[1,"product-summary"],["appearance","outline",1,"small-field"],["matInput","","type","text","appMoneyInput","","decimalType","quantity",3,"ngModelChange","ngModel"],["matInput","","type","text","appMoneyInput","","decimalType","price",3,"ngModelChange","ngModel"],["mat-mini-fab","","color","accent","matTooltip","Agregar l\xEDnea",3,"click","disabled"],["mat-header-cell",""],["mat-cell",""],["mat-icon-button","","color","warn",3,"click"],["mat-header-row",""],["mat-row",""],[1,"empty-state"]],template:function(n,t){if(n&1){let a=w();r(0,"div",2)(1,"h2"),c(2,"Gesti\xF3n de Inventario (Movimientos Masivos)"),o(),r(3,"mat-card",3)(4,"mat-card-content")(5,"form",4)(6,"div",5)(7,"mat-form-field",6)(8,"mat-label"),c(9,"Fecha"),o(),y(10,"input",7)(11,"mat-datepicker-toggle",8)(12,"mat-datepicker",null,0),o(),r(14,"mat-form-field",6)(15,"mat-label"),c(16,"Almac\xE9n"),o(),r(17,"mat-select",9),u(18,Xe,2,2,"mat-option",10),o()(),r(19,"mat-form-field",11)(20,"mat-label"),c(21,"Tipo de Movimiento"),o(),r(22,"mat-select",12),S("selectionChange",function(){return s(a),p(t.onReasonChange())}),u(23,Ye,2,3,"mat-option",10),o()()()()()(),r(24,"mat-card",13)(25,"mat-card-content")(26,"div",14)(27,"div",15)(28,"mat-icon",16),c(29,"qr_code_scanner"),o(),r(30,"input",17,1),T("ngModelChange",function(h){return s(a),E(t.barcode,h)||(t.barcode=h),p(h)}),S("ngModelChange",function(h){return s(a),p(t.onBarcodeChange(h))})("keyup.enter",function(h){return s(a),p(t.onBarcodeEnter(h))}),o()(),r(32,"button",18),S("click",function(){return s(a),p(t.openProductSelector())}),r(33,"mat-icon"),c(34,"search"),o(),c(35," Buscar Producto "),o(),u(36,Ze,2,0,"div",19)(37,et,19,11,"ng-container",20),o()()(),r(38,"div",21)(39,"table",22),M(40,23),u(41,tt,2,0,"th",24)(42,nt,2,1,"td",25),C(),M(43,26),u(44,it,2,0,"th",24)(45,ot,3,4,"td",25),C(),M(46,27),u(47,rt,2,0,"th",24)(48,at,3,6,"td",25),C(),M(49,28),u(50,ct,2,0,"th",24)(51,lt,3,6,"td",25),C(),M(52,29),u(53,mt,1,0,"th",24)(54,dt,4,0,"td",25),C(),u(55,st,1,0,"tr",30)(56,pt,1,0,"tr",31),o(),u(57,ut,2,0,"div",32),o(),r(58,"div",33)(59,"div",34),c(60),x(61,"number"),x(62,"currency"),o(),r(63,"button",35),S("click",function(){return s(a),p(t.saveEverything())}),r(64,"mat-icon"),c(65,"save"),o(),c(66," GUARDAR MOVIMIENTOS "),o()()()}if(n&2){let a=A(13);l(5),d("formGroup",t.headerForm),l(5),d("matDatepicker",a),l(),d("for",a),l(7),d("ngForOf",t.locations),l(5),d("ngForOf",t.reasons),l(7),P("ngModel",t.barcode),l(6),d("ngIf",!t.currentProduct),l(),d("ngIf",t.currentProduct),l(2),d("dataSource",t.lines),l(16),d("matHeaderRowDef",t.displayedColumns),l(),d("matRowDefColumns",t.displayedColumns),l(),d("ngIf",t.lines.length===0),l(3),B(" Total Unidades: ",F(61,15,t.getTotalUnits(),t.settingsService.getDecimalFormat("quantity"))," | Importe Total: ",k(62,18,t.getTotalAmount(),"USD","$ ",t.settingsService.getDecimalFormat("total"))," "),l(3),d("disabled",t.lines.length===0||t.headerForm.invalid)}},dependencies:[G,$,L,de,re,te,ne,ie,le,oe,se,ce,ae,Me,he,ge,_e,Se,Ce,Y,J,X,Q,Ne,Re,K,Le,Ae,We,$e,z,ye,xe,Ue,we,Ee,Be,Te,Pe,Fe,De,Ie,Oe,Ve,fe,pe,ue,je,ve,be,ee,Ge,H,j],styles:[".container[_ngcontent-%COMP%]{padding:20px;display:flex;flex-direction:column;gap:20px}.header-card[_ngcontent-%COMP%], .input-card[_ngcontent-%COMP%]{padding:10px}.row[_ngcontent-%COMP%]{display:flex;gap:20px;flex-wrap:wrap}.reason-field[_ngcontent-%COMP%]{flex-grow:1}.input-row[_ngcontent-%COMP%]{display:flex;align-items:center;gap:20px}.info-text[_ngcontent-%COMP%]{color:#888;font-style:italic}.product-summary[_ngcontent-%COMP%]{background:#e0f7fa;padding:5px 10px;border-radius:4px;border:1px solid #4dd0e1}.small-field[_ngcontent-%COMP%]{width:100px}.table-container[_ngcontent-%COMP%]{max-height:400px;overflow:auto;background:#fff}.empty-state[_ngcontent-%COMP%]{padding:20px;text-align:center;color:#999}.footer-actions[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center;padding:20px;background:#fff;border-top:1px solid #eee;position:sticky;bottom:0}.totals[_ngcontent-%COMP%]{font-weight:700;font-size:1.1em}.barcode-container[_ngcontent-%COMP%]{display:flex;align-items:center;background:#f0f2f5;border-radius:8px;padding:4px 12px;border:1px solid #ddd;box-shadow:inset 0 1px 3px #0000000d;transition:all .3s ease;width:200px;height:40px}.barcode-container[_ngcontent-%COMP%]:focus-within{border-color:#6200ee;background:#fff}.barcode-icon[_ngcontent-%COMP%]{font-size:20px;width:20px;height:20px;color:#666;margin-right:8px}.barcode-input[_ngcontent-%COMP%]{border:none;background:transparent;outline:none;width:100%;font-size:.9rem;color:#333}"]})}return i})();export{Yt as StockManagementComponent};
