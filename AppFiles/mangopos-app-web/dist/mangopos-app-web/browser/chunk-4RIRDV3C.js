import{a as Ne}from"./chunk-QS7ZRVAC.js";import{a as Ee,b as Te,c as ke}from"./chunk-HIZ742YJ.js";import{a as Pe,b as Le,c as Re,d as Fe,e as Be,f as Oe,g as We,h as q}from"./chunk-Z6YHTX75.js";import{a as ne,b as re}from"./chunk-26KDQVR5.js";import{a as fe}from"./chunk-SCPRHZYR.js";import{b as $,c as z}from"./chunk-APXOZHQA.js";import{a as _e,b as he,c as Ce,d as Me,e as we,f as Se,g as be,h as De,i as ye,j as ve,l as xe,m as Ue}from"./chunk-VJGP4MMT.js";import{a as Ie,b as H}from"./chunk-VNZMNOUU.js";import{a as Ve}from"./chunk-YCMZOG5D.js";import{a as le,b as se,c as me,f as ce,h as de}from"./chunk-ZWM7H6SC.js";import{a as ge}from"./chunk-PALJ6VDH.js";import"./chunk-TEMJ73U5.js";import{d as ae}from"./chunk-52A733DE.js";import"./chunk-GPHRSLLH.js";import{b as W,e as pe,f as ue,i as N,j}from"./chunk-EWTXOCXT.js";import{b as R,f as F,j as B,u as oe,x as O}from"./chunk-AVLO2MYP.js";import{a as Q,b as A}from"./chunk-JI7GBIO6.js";import"./chunk-VTP6RNFS.js";import{H as V,I as P,K as L}from"./chunk-M7DMR53X.js";import"./chunk-JAVK727W.js";import{d as ie}from"./chunk-3TNWXQYU.js";import"./chunk-UWUK32S4.js";import{k as te,l as T,v as k}from"./chunk-ZD4QWOHN.js";import{$ as C,$b as X,Fb as u,Gb as a,Hb as r,Ib as x,Mb as w,Nb as S,Pb as M,Sa as U,Ub as g,W as K,Wa as s,Wb as h,_b as J,ac as Y,db as I,ea as d,ec as Z,fa as p,ic as o,jb as E,jc as ee,kc as b,nc as D,oc as y,pb as _,pc as v}from"./chunk-WSMHJDAT.js";import{a as G}from"./chunk-C6Q5SG76.js";var je=(()=>{class i{http=C(ie);apiUrl=`${Ve.apiUrl}/users`;getUsers(e=1,n=10,t){let l={page:e.toString(),limit:n.toString()};return t&&(l.search=t),this.http.get(this.apiUrl,{params:l})}getUserById(e){return this.http.get(`${this.apiUrl}/${e}`)}createUser(e){return this.http.post(this.apiUrl,e)}updateUser(e,n){return this.http.put(`${this.apiUrl}/${e}`,n)}changePassword(e,n){return this.http.put(`${this.apiUrl}/${e}/password`,{password:n})}deleteUser(e){return this.http.delete(`${this.apiUrl}/${e}`)}static \u0275fac=function(n){return new(n||i)};static \u0275prov=K({token:i,factory:i.\u0275fac,providedIn:"root"})}return i})();function ze(i,m){if(i&1){let e=M();a(0,"button",19),g("click",function(){d(e);let t=h();return p(t.clearSearch())}),a(1,"mat-icon"),o(2,"close"),r()()}}function Qe(i,m){i&1&&(a(0,"th",20),o(1," Imagen "),r())}function Ae(i,m){if(i&1){let e=M();a(0,"td",21)(1,"img",22),g("error",function(){let t=d(e).$implicit;return p(t.image=null)}),r()()}if(i&2){let e=m.$implicit,n=h();s(),u("src",n.getImageSrc(e.image),U)}}function He(i,m){i&1&&(a(0,"th",20),o(1," Nombre "),r())}function qe(i,m){if(i&1&&(a(0,"td",21),o(1),r()),i&2){let e=m.$implicit;s(),b(" ",e.name," ")}}function Ge(i,m){i&1&&(a(0,"th",20),o(1," Rol "),r())}function Ke(i,m){if(i&1&&(a(0,"td",21),o(1),r()),i&2){let e=m.$implicit;s(),b(" ",e.role_name," ")}}function Je(i,m){i&1&&(a(0,"th",20),o(1," Tarjeta "),r())}function Xe(i,m){if(i&1&&(a(0,"td",21),o(1),r()),i&2){let e=m.$implicit;s(),b(" ",e.card," ")}}function Ye(i,m){i&1&&(a(0,"th",20),o(1," Acciones "),r())}function Ze(i,m){if(i&1){let e=M();a(0,"td",21)(1,"button",23),g("click",function(){let t=d(e).$implicit,l=h();return p(l.editUser(t))}),a(2,"mat-icon"),o(3,"edit"),r()(),a(4,"button",24),g("click",function(){let t=d(e).$implicit,l=h();return p(l.changePassword(t))}),a(5,"mat-icon"),o(6,"key"),r()(),a(7,"button",25),g("click",function(){let t=d(e).$implicit,l=h();return p(l.deleteUser(t))}),a(8,"mat-icon"),o(9,"delete"),r()()()}}function et(i,m){i&1&&x(0,"tr",26)}function tt(i,m){i&1&&x(0,"tr",27)}function it(i,m){if(i&1){let e=M();a(0,"div",15),x(1,"img",16),a(2,"button",17),g("click",function(){d(e);let t=h();return p(t.removeImage())}),a(3,"mat-icon"),o(4,"delete"),r()()()}if(i&2){let e=h();s(),u("src",e.previewImage||e.localData.image,U)}}function at(i,m){if(i&1&&(a(0,"mat-option",18),o(1),r()),i&2){let e=m.$implicit;u("value",e.id),s(),b(" ",e.name," ")}}function nt(i,m){if(i&1){let e=M();a(0,"mat-form-field",6)(1,"mat-label"),o(2,"Contrase\xF1a"),r(),a(3,"input",19),v("ngModelChange",function(t){d(e);let l=h();return y(l.localData.password,t)||(l.localData.password=t),p(t)}),r()()}if(i&2){let e=h();s(3),D("ngModel",e.localData.password)}}var $t=(()=>{class i{userService=C(je);roleService=C(Ne);dialog=C(Re);snackBar=C(ne);dataSource=new Ue([]);roles=[];displayedColumns=["image","name","role","card","actions"];totalRecords=0;pageSize=50;currentPage=1;searchQuery="";paginator;ngOnInit(){this.loadUsers(),this.loadRoles()}getImageSrc(e){return!e||typeof e!="string"?"assets/images/default-avatar.png":e.startsWith("data:image")||e.startsWith("http")?e:`data:image/png;base64,${e}`}loadUsers(){this.userService.getUsers(this.currentPage,this.pageSize,this.searchQuery).subscribe({next:e=>{this.dataSource.data=e.data,this.totalRecords=e.total},error:e=>{console.error("Error loading users",e),this.dataSource.data=[],this.totalRecords=0}})}onPageChange(e){this.currentPage=e.pageIndex+1,this.pageSize=e.pageSize,this.loadUsers()}onSearch(){this.currentPage=1,this.paginator&&(this.paginator.pageIndex=0),this.loadUsers()}clearSearch(){this.searchQuery="",this.onSearch()}loadRoles(){this.roleService.getRoles().subscribe({next:e=>this.roles=e,error:e=>console.error("Error loading roles",e)})}editUser(e){this.dialog.open(rt,{width:"500px",data:{user:e||{},roles:this.roles,isNew:!e}}).afterClosed().subscribe(t=>{t&&(e?.id?this.userService.updateUser(e.id,t).subscribe(()=>{this.snackBar.open("Usuario actualizado","Cerrar",{duration:3e3}),this.loadUsers()}):this.userService.createUser(t).subscribe({next:()=>{this.snackBar.open("Usuario creado","Cerrar",{duration:3e3}),this.loadUsers()},error:l=>{this.snackBar.open(l.error?.message||"Error al crear usuario","Cerrar",{duration:3e3})}}))})}changePassword(e){let n=prompt(`Ingrese nueva contrase\xF1a para ${e.name}:`);n&&this.userService.changePassword(e.id,n).subscribe({next:()=>this.snackBar.open("Contrase\xF1a actualizada","Cerrar",{duration:3e3}),error:t=>this.snackBar.open("Error al cambiar contrase\xF1a","Cerrar",{duration:3e3})})}deleteUser(e){confirm(`\xBFEst\xE1 seguro de eliminar al usuario "${e.name}"?`)&&this.userService.deleteUser(e.id).subscribe({next:()=>{this.snackBar.open("Usuario eliminado","Cerrar",{duration:3e3}),this.loadUsers()},error:n=>{this.snackBar.open("Error al eliminar usuario","Cerrar",{duration:3e3})}})}static \u0275fac=function(n){return new(n||i)};static \u0275cmp=E({type:i,selectors:[["app-users-list"]],viewQuery:function(n,t){if(n&1&&J(Ee,5),n&2){let l;X(l=Y())&&(t.paginator=l.first)}},decls:37,vars:8,consts:[[1,"container"],[1,"main-card"],[1,"header-actions"],["appearance","outline",1,"search-field"],["matPrefix",""],["matInput","","placeholder","Nombre o Tarjeta",3,"ngModelChange","keyup.enter","ngModel"],["matSuffix","","mat-icon-button","",3,"click",4,"ngIf"],["mat-raised-button","","color","primary",3,"click"],["mat-table","",1,"users-table",3,"dataSource"],["matColumnDef","image"],["mat-header-cell","",4,"matHeaderCellDef"],["mat-cell","",4,"matCellDef"],["matColumnDef","name"],["matColumnDef","role"],["matColumnDef","card"],["matColumnDef","actions"],["mat-header-row","",4,"matHeaderRowDef"],["mat-row","",4,"matRowDef","matRowDefColumns"],[3,"page","length","pageSize","pageIndex"],["matSuffix","","mat-icon-button","",3,"click"],["mat-header-cell",""],["mat-cell",""],[1,"user-avatar",3,"error","src"],["mat-icon-button","","color","primary","matTooltip","Editar",3,"click"],["mat-icon-button","","color","accent","matTooltip","Cambiar Contrase\xF1a",3,"click"],["mat-icon-button","","color","warn","matTooltip","Eliminar",3,"click"],["mat-header-row",""],["mat-row",""]],template:function(n,t){n&1&&(a(0,"div",0)(1,"mat-card",1)(2,"mat-card-header")(3,"mat-card-title"),o(4,"Gesti\xF3n de Usuarios"),r(),a(5,"div",2)(6,"mat-form-field",3)(7,"mat-icon",4),o(8,"search"),r(),a(9,"mat-label"),o(10,"Buscar usuario..."),r(),a(11,"input",5),v("ngModelChange",function(f){return y(t.searchQuery,f)||(t.searchQuery=f),f}),g("keyup.enter",function(){return t.onSearch()}),r(),_(12,ze,3,0,"button",6),r(),a(13,"button",7),g("click",function(){return t.editUser(null)}),a(14,"mat-icon"),o(15,"person_add"),r(),o(16," Nuevo Usuario "),r()()(),a(17,"mat-card-content")(18,"table",8),w(19,9),_(20,Qe,2,0,"th",10)(21,Ae,2,1,"td",11),S(),w(22,12),_(23,He,2,0,"th",10)(24,qe,2,1,"td",11),S(),w(25,13),_(26,Ge,2,0,"th",10)(27,Ke,2,1,"td",11),S(),w(28,14),_(29,Je,2,0,"th",10)(30,Xe,2,1,"td",11),S(),w(31,15),_(32,Ye,2,0,"th",10)(33,Ze,10,0,"td",11),S(),_(34,et,1,0,"tr",16)(35,tt,1,0,"tr",17),r(),a(36,"app-shared-paginator",18),g("page",function(f){return t.onPageChange(f)}),r()()()()),n&2&&(s(11),D("ngModel",t.searchQuery),s(),u("ngIf",t.searchQuery),s(6),u("dataSource",t.dataSource),s(16),u("matHeaderRowDef",t.displayedColumns),s(),u("matRowDefColumns",t.displayedColumns),s(),u("length",t.totalRecords)("pageSize",t.pageSize)("pageIndex",t.currentPage-1))},dependencies:[k,T,O,R,F,B,de,le,me,ce,se,L,P,V,A,Q,xe,_e,Ce,be,Me,he,De,we,Se,ye,ve,q,re,j,N,W,pe,ue,z,$,H,Te,ke,fe,ge],styles:[".container[_ngcontent-%COMP%], .main-card[_ngcontent-%COMP%]{padding:20px}mat-card-header[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}.header-actions[_ngcontent-%COMP%]{margin-left:auto;display:flex;align-items:center;gap:15px}.search-field[_ngcontent-%COMP%]{width:300px}.search-field[_ngcontent-%COMP%]     .mat-mdc-form-field-subscript-wrapper{display:none}.users-table[_ngcontent-%COMP%]{width:100%;margin-top:10px}.user-avatar[_ngcontent-%COMP%]{width:40px;height:40px;border-radius:50%;object-fit:cover}"]})}return i})(),rt=(()=>{class i{data;dialogRef;localData;previewImage=null;selectedFile=null;constructor(e,n){this.data=e,this.dialogRef=n,this.localData=G({},e.user),this.localData.image&&!this.localData.image.startsWith("data:image")&&!this.localData.image.startsWith("http")&&(this.localData.image=`data:image/png;base64,${this.localData.image}`)}onFileSelected(e){let n=e.target.files[0];if(n){this.selectedFile=n;let t=new FileReader;t.onload=()=>{this.previewImage=t.result,this.localData.image=this.previewImage},t.readAsDataURL(n)}}removeImage(){this.localData.image=null,this.previewImage=null,this.selectedFile=null}onSave(){if(this.localData.image&&this.localData.image.startsWith("data:image")){let e=this.localData.image.indexOf(",");e>-1&&(this.localData.image=this.localData.image.substring(e+1))}this.dialogRef.close(this.localData)}static \u0275fac=function(n){return new(n||i)(I(Le),I(Pe))};static \u0275cmp=E({type:i,selectors:[["app-user-dialog"]],decls:30,vars:9,consts:[["fileInput",""],["mat-dialog-title",""],[1,"avatar-upload"],["class","preview-container",4,"ngIf"],["mat-stroked-button","","color","primary","type","button",3,"click"],["type","file","accept","image/*",2,"display","none",3,"change"],["appearance","outline",1,"full-width"],["matInput","","required","",3,"ngModelChange","ngModel"],["required","",3,"ngModelChange","ngModel"],[3,"value",4,"ngFor","ngForOf"],["matInput","",3,"ngModelChange","ngModel"],["appearance","outline","class","full-width",4,"ngIf"],["align","end"],["mat-button","","mat-dialog-close",""],["mat-raised-button","","color","primary",3,"click","disabled"],[1,"preview-container"],[1,"avatar-preview",3,"src"],["mat-icon-button","","color","warn","type","button","matTooltip","Eliminar imagen",1,"remove-btn",3,"click"],[3,"value"],["matInput","","type","password","required","",3,"ngModelChange","ngModel"]],template:function(n,t){if(n&1){let l=M();a(0,"h2",1),o(1),r(),a(2,"mat-dialog-content")(3,"div",2),_(4,it,5,1,"div",3),a(5,"button",4),g("click",function(){d(l);let c=Z(10);return p(c.click())}),a(6,"mat-icon"),o(7,"cloud_upload"),r(),o(8),r(),a(9,"input",5,0),g("change",function(c){return d(l),p(t.onFileSelected(c))}),r()(),a(11,"mat-form-field",6)(12,"mat-label"),o(13,"Nombre"),r(),a(14,"input",7),v("ngModelChange",function(c){return d(l),y(t.localData.name,c)||(t.localData.name=c),p(c)}),r()(),a(15,"mat-form-field",6)(16,"mat-label"),o(17,"Rol"),r(),a(18,"mat-select",8),v("ngModelChange",function(c){return d(l),y(t.localData.role,c)||(t.localData.role=c),p(c)}),_(19,at,2,2,"mat-option",9),r()(),a(20,"mat-form-field",6)(21,"mat-label"),o(22,"Tarjeta (Card Key)"),r(),a(23,"input",10),v("ngModelChange",function(c){return d(l),y(t.localData.card,c)||(t.localData.card=c),p(c)}),r()(),_(24,nt,4,1,"mat-form-field",11),r(),a(25,"mat-dialog-actions",12)(26,"button",13),o(27,"Cancelar"),r(),a(28,"button",14),g("click",function(){return d(l),p(t.onSave())}),o(29," Guardar "),r()()}n&2&&(s(),ee(t.data.isNew?"Nuevo Usuario":"Editar Usuario"),s(3),u("ngIf",t.localData.image||t.previewImage),s(4),b(" ",t.localData.image||t.previewImage?"Cambiar Imagen":"Subir Imagen"," "),s(6),D("ngModel",t.localData.name),s(4),D("ngModel",t.localData.role),s(),u("ngForOf",t.data.roles),s(4),D("ngModel",t.localData.card),s(),u("ngIf",t.data.isNew),s(4),u("disabled",!t.localData.name||!t.localData.role||t.data.isNew&&!t.localData.password))},dependencies:[k,te,T,O,R,F,oe,B,L,P,V,j,N,W,z,$,H,Ie,ae,q,Fe,Be,We,Oe,A,Q],styles:[".full-width[_ngcontent-%COMP%]{width:100%;margin-bottom:15px}.avatar-upload[_ngcontent-%COMP%]{display:flex;flex-direction:column;align-items:center;gap:10px;margin-bottom:20px}.preview-container[_ngcontent-%COMP%]{position:relative;display:inline-block}.avatar-preview[_ngcontent-%COMP%]{width:100px;height:100px;border-radius:50%;object-fit:cover;border:2px solid #ccc}.remove-btn[_ngcontent-%COMP%]{position:absolute;top:-10px;right:-10px;background:#fff;border-radius:50%}"]})}return i})();export{rt as UserDialogComponent,$t as UsersListComponent};
